<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 AEC Report</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --p1: #1e3a8a; --p2: #3b82f6; --acc: #facc15; --succ: #22c55e; --dang: #ef4444; --bg: #f8fafc; }
        body { font-family: 'Kanit', sans-serif; background: var(--bg); margin: 0; padding: 0; color: #1e293b; }
        .container { max-width: 500px; margin: 0 auto; padding: 15px; }
        .card { background: white; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
        h1 { color: var(--p1); text-align: center; font-size: 26px; margin: 15px 0; }
        h2 { font-size: 18px; color: var(--p2); border-left: 5px solid var(--acc); padding-left: 10px; margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px; color: #475569; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 12px; font-size: 16px; font-family: 'Kanit'; box-sizing: border-box; margin-bottom: 15px; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn-menu { border: none; border-radius: 18px; padding: 25px 10px; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 10px; transition: 0.2s; font-weight: 600; }
        .bg-blue { background: linear-gradient(135deg, #0284c7, #075985); }
        .bg-green { background: linear-gradient(135deg, #16a34a, #14532d); }
        .bg-orange { background: linear-gradient(135deg, #ea580c, #9a3412); }
        .bg-purple { background: linear-gradient(135deg, #9333ea, #581c87); }
        .bg-pink { background: linear-gradient(135deg, #db2777, #831843); }
        .bg-slate { background: linear-gradient(135deg, #475569, #1e293b); }
        .btn-main { background: var(--p1); color: white; border: none; width: 100%; padding: 15px; border-radius: 12px; font-size: 18px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .btn-back { background: #e2e8f0; color: #475569; }
        .preview-box { background: #f1f5f9; border-radius: 12px; padding: 10px; text-align: center; margin-bottom: 15px; display: none; }
        .preview-img { max-width: 100%; border-radius: 8px; }
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .spin { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--p1); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .page { display: none; }
        .active { display: block; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { border: 1px solid #e2e8f0; padding: 8px; text-align: left; }
        th { background: var(--p1); color: white; }
    </style>
</head>
<body>

<div id="loader"><div class="spin"></div><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... ‡∏´‡πâ‡∏≤‡∏°‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ô‡∏µ‡πâ</p></div>

<div class="container">
    <div id="page-home" class="page active">
        <h1>2026 AEC Report</h1>
        <div class="card">
            <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô (Name)</label>
            <input type="text" id="main_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
            <label>‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î (Region)</label>
            <select id="main_region">
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ --</option>
                <option>BKK</option><option>CR</option><option>ER</option><option>NER</option><option>NR</option><option>SR</option><option>TE</option><option>DR</option><option>OFFICE</option>
            </select>
        </div>
        <div class="menu-grid">
            <button class="btn-menu bg-blue" onclick="navTo('check', 'Site Check In')"><i class="fas fa-map-marker-alt fa-2x"></i>Site Check In</button>
            <button class="btn-menu bg-green" onclick="navTo('check', 'Check In')"><i class="fas fa-sign-in-alt fa-2x"></i>Check In</button>
            <button class="btn-menu bg-orange" onclick="navTo('check', 'Check Out')"><i class="fas fa-sign-out-alt fa-2x"></i>Check Out</button>
            <button class="btn-menu bg-purple" onclick="navTo('report')"><i class="fas fa-clipboard-list fa-2x"></i>Report</button>
            <button class="btn-menu bg-pink" onclick="navTo('expenses')"><i class="fas fa-wallet fa-2x"></i>Expenses</button>
            <button class="btn-menu bg-slate" onclick="navTo('capture')"><i class="fas fa-camera fa-2x"></i>Capture</button>
        </div>
    </div>

    <div id="page-check" class="page">
        <h2 id="check-title">Check In</h2>
        <div id="check-form-fields"></div>
        <div class="card">
            <label>üì∏ ‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏Å‡∏±‡∏î (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
            <input type="file" id="check_file" accept="image/*" capture="camera" onchange="previewFile(this, 'check_prev')">
            <div id="check_prev_div" class="preview-box">
                <img id="check_prev" class="preview-img">
                <p id="gps_display" style="font-size:12px; color:var(--p1);"></p>
            </div>
        </div>
        <button class="btn-main" onclick="submitCheck()">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <button class="btn-main btn-back" onclick="goHome()">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
    </div>

    <div id="page-report" class="page">
        <h2>üìù ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•</h2>
        <div class="card">
            <label>Buddy (‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô)</label><input type="text" id="rep_buddy">
            <label>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="rep_date">
            <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</label>
            <select id="rep_job" onchange="toggleDiv('rep_etc_div', this.value==='‡∏á‡∏≤‡∏ô ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ')">
                <option>‡∏á‡∏≤‡∏ô CR</option><option>‡∏á‡∏≤‡∏ô OFFICE</option><option>‡∏á‡∏≤‡∏ô TE</option><option>‡∏á‡∏≤‡∏ô DRONE</option><option>‡∏á‡∏≤‡∏ô ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
            </select>
            <div id="rep_etc_div" style="display:none;"><label>‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô</label><input type="text" id="rep_etc"></div>
            <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</label><textarea id="rep_detail" rows="3"></textarea>
        </div>
        <button class="btn-main" onclick="handleReportNext()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ûî</button>
        <button class="btn-main btn-back" onclick="goHome()">‡∏Å‡∏•‡∏±‡∏ö</button>
    </div>

    <div id="page-report-cr" class="page">
        <h2 id="cr-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô CR ‡πÑ‡∏ã‡∏ï‡πå‡∏ó‡∏µ‡πà 1</h2>
        <div class="card" id="cr-form-area"></div>
        <button class="btn-main" onclick="processCRSite()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ / ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
    </div>

    <div id="page-expenses" class="page">
        <h2>üí∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h2>
        <div id="exp-step-1">
            <div class="card">
                <label>Buddy</label><input type="text" id="exp_buddy">
                <label>‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="exp_date">
                <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</label><select id="exp_job"><option>‡∏á‡∏≤‡∏ô CR</option><option>‡∏á‡∏≤‡∏ô OFFICE</option><option>‡∏á‡∏≤‡∏ô TE</option><option>‡∏á‡∏≤‡∏ô DRONE</option><option>‡∏á‡∏≤‡∏ô ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option></select>
                <label>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ã‡∏ï‡πå / ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label><input type="text" id="exp_site" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ã‡∏ï‡πå"><input type="text" id="exp_pv" placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î">
            </div>
            <div class="card">
                <label>‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô (No.1)</label><input type="number" id="exp_oil" value="0">
                <label>‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å (No.2)</label><input type="number" id="exp_hotel" value="0">
                <label>‡∏õ‡∏ä‡∏Ñ. (No.3)</label><input type="number" id="exp_ccr" value="0">
                <label>‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á (No.4)</label><input type="number" id="exp_trav" value="0">
            </div>
            <button class="btn-main" onclick="showExpStep(2)">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ûî</button>
        </div>
        <div id="exp-step-2" style="display:none;">
            <div class="card">
                <label>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©</label>
                <select id="exp_spc_type"><option>‡πÑ‡∏°‡πà‡∏°‡∏µ</option><option>‡πÄ‡∏ö‡∏¥‡∏Å‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô/‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡∏°/‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ</option><option>‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option><option>‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤</option><option>‡∏ó‡∏≥‡∏ü‡∏±‡∏ô (‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£)</option><option>‡∏Ñ‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•/‡∏Ñ‡πà‡∏≤‡∏¢‡∏≤ (‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£)</option><option>‡∏Ñ‡πà‡∏≤‡∏™‡∏±‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡∏≤‡∏£/‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á (‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß)</option><option>‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</option><option>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏µ/‡∏õ‡∏Å‡∏™.‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</option></select>
                <label>‡πÄ‡∏á‡∏¥‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡∏ö‡∏≤‡∏ó)</label><input type="number" id="exp_spc_val" value="0">
                <label>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏¥‡∏• (‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß)</label>
                <input type="text" id="exp_nb_name" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ñ‡πâ‡∏≤‡∏°‡∏µ">
                <label>‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏¥‡∏• (‡∏ö‡∏≤‡∏ó)</label><input type="number" id="exp_nb_val" value="0">
            </div>
            <button class="btn-main" onclick="showExpStep(3)">‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ö‡∏¥‡∏• ‚ûî</button>
        </div>
        <div id="exp-step-3" style="display:none;">
            <div class="card">
                <label>üì∏ ‡∏£‡∏π‡∏õ‡∏ö‡∏¥‡∏• (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡∏£‡∏π‡∏õ)</label>
                <input type="file" id="exp_files" multiple accept="image/*" onchange="previewMultiFile(this)">
                <div id="exp_multi_prev_div" class="preview-box">
                    <img id="exp_multi_prev" class="preview-img">
                    <p id="exp_count_text"></p>
                </div>
            </div>
            <button class="btn-main" onclick="summarizeExp()">‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á ‚ûî</button>
        </div>
        <div id="exp-step-summary" style="display:none;">
            <div class="card" id="exp_final_summary"></div>
            <button class="btn-main" onclick="submitExp()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á</button>
            <button class="btn-main btn-back" onclick="showExpStep(1)">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        </div>
    </div>

    <div id="page-capture" class="page">
        <h2>üì∏ Capture Report</h2>
        <div class="card">
            <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><select id="cap_date_sel"></select>
            <button class="btn-main" style="background:var(--p2)" onclick="fetchCaptureData()">‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
        <div id="cap_results_area" style="overflow-x:auto"></div>
        <button class="btn-main btn-back" onclick="goHome()">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
    </div>

    <div id="page-final-1" class="page">
        <div class="card" style="text-align:center">
            <i class="fas fa-check-circle fa-4x" style="color:var(--succ)"></i>
            <h2>‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! Safety First</h2>
            <p>‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö</p>
            <button class="btn-main" onclick="goHome()">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
        </div>
    </div>
    <div id="page-final-2" class="page">
        <div class="card" style="text-align:center">
            <i class="fas fa-paper-plane fa-4x" style="color:var(--p2)"></i>
            <h2>‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!</h2>
            <p>‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡∏ö</p>
            <button class="btn-main" onclick="goHome()">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
        </div>
    </div>
</div>

<script>
    let currentImgs = [];
    let currentGPS = { stamp: "-", code: "-", addr: "-" };
    let crSiteIndex = 1;
    let crTempData = {};

    window.onload = () => {
        document.getElementById('main_name').value = localStorage.getItem('kk_name') || "";
        document.getElementById('main_region').value = localStorage.getItem('kk_reg') || "";
        const sel = document.getElementById('cap_date_sel');
        for(let i=0; i<8; i++) {
            let d = new Date(); d.setDate(d.getDate() - i);
            let ds = d.toLocaleDateString('th-TH');
            sel.innerHTML += `<option value="${ds}">${ds}</option>`;
        }
    };

    function navTo(p, status = "") {
        const name = document.getElementById('main_name').value;
        const reg = document.getElementById('main_region').value;
        if(!name || !reg) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏Ñ‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î"); return; }
        localStorage.setItem('kk_name', name);
        localStorage.setItem('kk_reg', reg);
        
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + p).classList.add('active');
        if(status) {
            currentStatus = status;
            document.getElementById('check-title').innerText = status;
            renderCheckForm(status);
        }
        window.scrollTo(0,0);
    }

    function renderCheckForm(s) {
        const area = document.getElementById('check-form-fields');
        area.innerHTML = s==='Site Check In' ? '' : `
            <div class="card">
                <label>Buddy</label><input type="text" id="c_buddy">
                <label>‡∏£‡∏ñ</label><input type="text" id="c_car">
                <label>‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå</label><input type="number" id="c_mile">
                <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label><input type="text" id="c_place">
                <label>${s.includes('Out') ? 'BRIFE' : 'PLAN'}</label><textarea id="c_plan"></textarea>
            </div>`;
        currentImgs = [];
        document.getElementById('check_prev_div').style.display='none';
    }

    function previewFile(input, id) {
        if(input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById(id).src = e.target.result;
                document.getElementById(id+'_div').style.display='block';
                currentImgs = [e.target.result];
            };
            reader.readAsDataURL(input.files[0]);
            getGPS();
        }
    }

    async function previewMultiFile(input) {
        currentImgs = [];
        for(let f of input.files) {
            if(currentImgs.length >= 10) break;
            const b64 = await new Promise(r => {
                const rd = new FileReader(); rd.onload = () => r(rd.result); rd.readAsDataURL(f);
            });
            currentImgs.push(b64);
        }
        document.getElementById('exp_multi_prev').src = currentImgs[0];
        document.getElementById('exp_multi_prev_div').style.display='block';
        document.getElementById('exp_count_text').innerText = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ${currentImgs.length} ‡∏£‡∏π‡∏õ`;
    }

    function getGPS() {
        document.getElementById('gps_display').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î...";
        navigator.geolocation.getCurrentPosition(p => {
            currentGPS.code = p.coords.latitude + "," + p.coords.longitude;
            currentGPS.stamp = new Date().toLocaleString('th-TH');
            document.getElementById('gps_display').innerText = "üìç " + currentGPS.code;
        }, () => {
            currentGPS.code = "0,0"; document.getElementById('gps_display').innerText = "‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡∏û‡∏ö";
        }, {enableHighAccuracy: true});
    }

    function callGas(payload, type) {
        document.getElementById('loader').style.display='flex';
        google.script.run
            .withSuccessHandler(res => {
                document.getElementById('loader').style.display='none';
                if(res.success) navTo('final-'+type);
                else alert("‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏£‡∏≤‡∏∞: " + res.error);
            })
            .withFailureHandler(err => {
                document.getElementById('loader').style.display='none';
                alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á: " + err.message);
            })
            .processForm(payload);
    }

    function submitCheck() {
        if(currentImgs.length===0) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ"); return; }
        const payload = {
            date: new Date().toLocaleDateString('th-TH'),
            time: new Date().toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'}),
            name: document.getElementById('main_name').value,
            region: document.getElementById('main_region').value,
            status: currentStatus, geoStamp: currentGPS.stamp, geoCode: currentGPS.code, geoAddress: "-",
            device: "Mobile/PC", images: currentImgs,
            buddy: document.getElementById('c_buddy')?.value || "",
            car: document.getElementById('c_car')?.value || "",
            mileage: document.getElementById('c_mile')?.value || "",
            place: document.getElementById('c_place')?.value || "",
            plan: document.getElementById('c_plan')?.value || ""
        };
        callGas(payload, currentStatus.includes('Out') ? '2' : '1');
    }

    function handleReportNext() {
        if(document.getElementById('rep_job').value==='‡∏á‡∏≤‡∏ô CR') {
            crSiteIndex = 1; crTempData = {}; navTo('report-cr'); renderCRSiteForm(1);
        } else {
            submitReportGeneric();
        }
    }

    function renderCRSiteForm(n) {
        const area = document.getElementById('cr-form-area');
        area.innerHTML = `
            ${n===1 ? '<label>‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏Ñ</label><select id="s_reg"><option>BKK</option><option>CR</option><option>ER</option><option>NER</option><option>NR</option><option>SR</option></select>' : ''}
            <label>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ã‡∏ï‡πå</label><input type="text" id="s_name">
            <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label><input type="text" id="s_prov">
            <label>‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏á‡∏≤‡∏ô</label><select id="s_job"><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥ CR - CRL</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡∏ó‡∏≥‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°</option><option>‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option></select>
            <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><input type="text" id="s_det">
            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ô‡∏≥</label><input type="text" id="s_ld">
            ${n<4 ? '<label>‡∏°‡∏µ‡πÑ‡∏ã‡∏ï‡πå‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</label><select id="s_next"><option value="no">‡πÑ‡∏°‡πà‡∏°‡∏µ/‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</option><option value="yes">‡∏°‡∏µ‡πÑ‡∏ã‡∏ï‡πå‡∏ó‡∏µ‡πà '+(n+1)+'</option></select>' : ''}
        `;
    }

    function processCRSite() {
        let n = crSiteIndex;
        if(n===1) crTempData[18] = document.getElementById('s_reg').value;
        let start = 19 + (n-1)*6;
        crTempData[start] = document.getElementById('s_name').value;
        crTempData[start+1] = document.getElementById('s_prov').value;
        crTempData[start+2] = document.getElementById('s_job').value;
        crTempData[start+4] = document.getElementById('s_det').value;
        crTempData[start+5] = document.getElementById('s_ld').value;
        
        if(document.getElementById('s_next')?.value==='yes') {
            crSiteIndex++; renderCRSiteForm(crSiteIndex);
        } else {
            submitReportGeneric(crTempData);
        }
    }

    function submitReportGeneric(extraData = {}) {
        const payload = {
            date: formatDate(document.getElementById('rep_date').value),
            name: document.getElementById('main_name').value,
            region: document.getElementById('main_region').value,
            status: "Report",
            buddy: document.getElementById('rep_buddy').value,
            extra: { 15: document.getElementById('rep_job').value, 17: document.getElementById('rep_detail').value, ...extraData }
        };
        callGas(payload, '2');
    }

    function showExpStep(n) {
        ['exp-step-1','exp-step-2','exp-step-3','exp-step-summary'].forEach(id => document.getElementById(id).style.display='none');
        document.getElementById('exp-step-'+(n===summary ? 'summary' : n)).style.display='block';
        if(n===summary) summarizeExp();
    }

    function summarizeExp() {
        const oil = Number(document.getElementById('exp_oil').value);
        const hot = Number(document.getElementById('exp_hotel').value);
        const ccr = Number(document.getElementById('exp_ccr').value);
        const trv = Number(document.getElementById('exp_trav').value);
        const total = oil+hot+ccr+trv;
        document.getElementById('exp_final_summary').innerHTML = `<h3>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏ö‡∏¥‡∏Å</h3><p>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${total} ‡∏ö‡∏≤‡∏ó</p><p>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏π‡∏õ: ${currentImgs.length}</p>`;
        document.getElementById('exp-step-3').style.display='none';
        document.getElementById('exp-step-summary').style.display='block';
    }

    function submitExp() {
        const payload = {
            date: formatDate(document.getElementById('exp_date').value),
            name: document.getElementById('main_name').value,
            region: document.getElementById('main_region').value,
            status: "Expenses", images: currentImgs,
            extra: { 43: document.getElementById('exp_site').value, 45: document.getElementById('exp_oil').value, 46: document.getElementById('exp_hotel').value }
        };
        callGas(payload, '2');
    }

    function fetchCaptureData() {
        const d = document.getElementById('cap_date_sel').value;
        document.getElementById('loader').style.display='flex';
        google.script.run.withSuccessHandler(res => {
            document.getElementById('loader').style.display='none';
            let html = "<table><tr>" + res.headers.slice(0,5).map(h => `<th>${h}</th>`).join('') + "</tr>";
            res.rows.forEach(r => { html += "<tr>" + r.slice(0,5).map(v => `<td>${v}</td>`).join('') + "</tr>"; });
            document.getElementById('cap_results_area').innerHTML = html + "</table>";
        }).getCaptureData(d);
    }

    function formatDate(v) { if(!v) return ""; const p = v.split('-'); return `${p[2]}/${p[1]}/${p[0]}`; }
    function toggleDiv(id, s) { document.getElementById(id).style.display = s?'block':'none'; }
    function goHome() { location.reload(); }
</script>

</body>
</html>
