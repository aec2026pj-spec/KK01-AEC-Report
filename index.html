<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #0D47A1; --secondary: #1976D2; --success: #2E7D32; --warning: #FBC02D; --danger: #D32F2F; --bg: #f0f2f5; }
    body { font-family: 'Kanit', sans-serif; background: var(--bg); margin: 0; padding: 10px; }
    .container { max-width: 500px; margin: 0 auto; background: white; border-radius: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 20px; box-sizing: border-box; min-height: 95vh; }
    h1 { color: var(--primary); text-align: center; font-size: 24px; border-bottom: 3px solid var(--warning); padding-bottom: 10px; }
    h2 { font-size: 18px; color: var(--secondary); border-left: 5px solid var(--warning); padding-left: 10px; margin-top: 20px; }
    .page { display: none; } .page.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .input-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; color: #444; }
    input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 15px; font-family: 'Kanit'; }
    .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
    .btn-menu { border: none; border-radius: 15px; padding: 20px 10px; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 10px; transition: 0.2s; }
    .btn-menu i { font-size: 24px; }
    .btn-site { background: #0097A7; } .btn-in { background: #43A047; } .btn-out { background: #FB8C00; }
    .btn-rep { background: #7B1FA2; } .btn-exp { background: #C2185B; } .btn-cap { background: #455A64; }
    .main-btn { background: var(--primary); color: white; width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; margin-top: 15px; cursor: pointer; }
    .back-btn { background: #777; margin-top: 10px; }
    .card { background: #f9f9f9; padding: 15px; border-radius: 15px; border: 1px solid #eee; margin-bottom: 10px; }
    #preview-box { text-align: center; display: none; margin-top: 10px; }
    #preview-img { max-width: 100%; border-radius: 10px; border: 2px solid #ddd; }
    .loading { display: none; text-align: center; padding: 20px; }
  </style>
</head>
<body>

<div class="container">
  <div id="page-home" class="page active">
    <h1>2026 AEC Report</h1>
    <div class="input-group">
      <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô (Name)</label>
      <input type="text" id="main_name" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô">
    </div>
    <div class="input-group">
      <label>‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î (Region)</label>
      <select id="main_region">
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ --</option>
        <option>BKK</option><option>CR</option><option>ER</option><option>NER</option><option>NR</option><option>SR</option><option>TE</option><option>DR</option><option>OFFICE</option>
      </select>
    </div>
    <div class="menu-grid">
      <button class="btn-menu btn-site" onclick="openFlow('Site Check In')"><i class="fas fa-map-marker-alt"></i>Site Check In</button>
      <button class="btn-menu btn-in" onclick="openFlow('Check In')"><i class="fas fa-sign-in-alt"></i>Check In</button>
      <button class="btn-menu btn-out" onclick="openFlow('Check Out')"><i class="fas fa-sign-out-alt"></i>Check Out</button>
      <button class="btn-menu btn-rep" onclick="openFlow('Report')"><i class="fas fa-file-alt"></i>Report</button>
      <button class="btn-menu btn-exp" onclick="openFlow('Expenses')"><i class="fas fa-wallet"></i>Expenses</button>
      <button class="btn-menu btn-cap" onclick="openFlow('Capture')"><i class="fas fa-camera"></i>Capture</button>
    </div>
  </div>

  <div id="page-check" class="page">
    <h2 id="check-title"></h2>
    <div id="check-dynamic-fields"></div>
    <div class="input-group">
      <label>‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û/‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</label>
      <input type="file" id="check-file" accept="image/*" capture="camera" onchange="previewImage(this)">
    </div>
    <div id="preview-box">
      <p id="gps-display" style="font-size:12px; color:blue;"></p>
      <img id="preview-img" src="">
    </div>
    <button class="main-btn" onclick="submitCheckData()">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <button class="main-btn back-btn" onclick="goHome()">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
  </div>

  <div id="page-report" class="page">
    <h2>üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (Report)</h2>
    <div class="card">
      <label>‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£ (Buddy)</label><input type="text" id="r_buddy" class="input-group">
      <label>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="r_date" class="input-group">
      <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</label>
      <select id="r_jobtype" onchange="toggleDiv('r_etc_div', this.value==='‡∏á‡∏≤‡∏ô ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ')">
        <option>‡∏á‡∏≤‡∏ô CR</option><option>‡∏á‡∏≤‡∏ô OFFICE</option><option>‡∏á‡∏≤‡∏ô TE</option><option>‡∏á‡∏≤‡∏ô DRONE</option><option>‡∏á‡∏≤‡∏ô ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
      </select>
      <div id="r_etc_div" style="display:none; margin-top:10px;"><label>‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô</label><input type="text" id="r_etc"></div>
      <label style="margin-top:10px;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</label><textarea id="r_detail" rows="3"></textarea>
    </div>
    <button class="main-btn" onclick="nextReportStep()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ûî</button>
    <button class="main-btn back-btn" onclick="goHome()">‡∏Å‡∏•‡∏±‡∏ö</button>
  </div>

  <div id="page-report-cr" class="page">
    <h2>üè¢ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô CR (‡πÑ‡∏ã‡∏ï‡πå 1-4)</h2>
    <div id="cr-container"></div>
  </div>

  <div id="page-expenses" class="page">
    <h2>üí∞ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (Expenses)</h2>
    <div id="exp-step-1">
      <div class="card">
        <label>‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£ (Buddy)</label><input type="text" id="ex_buddy" class="input-group">
        <label>‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="ex_date" class="input-group">
        <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</label>
        <select id="ex_jobtype" onchange="toggleDiv('ex_etc_div_e', this.value==='‡∏á‡∏≤‡∏ô ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ')">
          <option>‡∏á‡∏≤‡∏ô CR</option><option>‡∏á‡∏≤‡∏ô OFFICE</option><option>‡∏á‡∏≤‡∏ô TE</option><option>‡∏á‡∏≤‡∏ô DRONE</option><option>‡∏á‡∏≤‡∏ô ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
        </select>
        <div id="ex_etc_div_e" style="display:none; margin-top:10px;"><label>‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô</label><input type="text" id="ex_etc"></div>
        <label style="margin-top:10px;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</label><textarea id="ex_detail" rows="2"></textarea>
      </div>
      <button class="main-btn" onclick="toggleExpStep(2)">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ûî</button>
    </div>
    
    <div id="exp-step-2" style="display:none;">
      <div class="card">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ã‡∏ï‡πå</label><input type="text" id="ex_epsite" class="input-group">
        <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label><input type="text" id="ex_eppv" class="input-group">
        <label>‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô (‡∏ö‡∏¥‡∏• No.1)</label><input type="number" id="ex_oil" value="0" class="input-group">
        <label>‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å (‡∏ö‡∏¥‡∏• No.2)</label><input type="number" id="ex_hotel" value="0" class="input-group">
        <label>‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏ó‡∏≥‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏° (‡∏ö‡∏¥‡∏• No.3)</label><input type="number" id="ex_ccr" value="0" class="input-group">
        <label>‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á (‡∏ö‡∏¥‡∏• No.4)</label><input type="number" id="ex_trav" value="0" class="input-group">
      </div>
      <button class="main-btn" onclick="toggleExpStep(3)">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ûî</button>
    </div>

    <div id="exp-step-3" style="display:none;">
      <div class="card">
        <label>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©</label>
        <select id="ex_spc_type" onchange="toggleDiv('ex_spc_v', this.value!=='‡πÑ‡∏°‡πà‡∏°‡∏µ')">
          <option>‡πÑ‡∏°‡πà‡∏°‡∏µ</option><option>‡πÄ‡∏ö‡∏¥‡∏Å‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô/‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡∏°/‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ</option><option>‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option><option>‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤</option><option>‡∏ó‡∏≥‡∏ü‡∏±‡∏ô (‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£)</option><option>‡∏Ñ‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</option><option>‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</option>
        </select>
        <div id="ex_spc_v" style="display:none; margin-top:10px;"><label>‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label><input type="number" id="ex_spc_cost" value="0"></div>
      </div>
      <div class="card">
        <label>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏¥‡∏•</label>
        <select id="ex_nb_type" onchange="toggleDiv('ex_nb_v', this.value!=='‡πÑ‡∏°‡πà‡∏°‡∏µ')">
          <option>‡πÑ‡∏°‡πà‡∏°‡∏µ</option><option>‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏¥‡∏•</option>
        </select>
        <div id="ex_nb_v" style="display:none; margin-top:10px;">
          <label>‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</label><input type="text" id="ex_nb_name" class="input-group">
          <label>‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label><input type="number" id="ex_nb_cost" value="0">
        </div>
      </div>
      <div class="card">
        <label>‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°</label>
        <select id="ex_scr_type" onchange="toggleDiv('ex_scr_v', this.value!=='‡πÑ‡∏°‡πà‡∏°‡∏µ')">
          <option>‡πÑ‡∏°‡πà‡∏°‡∏µ</option><option>‡∏°‡∏µ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°</option>
        </select>
        <div id="ex_scr_v" style="display:none; margin-top:10px;">
          <label>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ã‡∏ï‡πå</label><input type="text" id="ex_scr_name" class="input-group">
          <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢</label><input type="date" id="ex_scr_date" class="input-group">
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label><input type="text" id="ex_scr_pro" class="input-group">
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label><input type="number" id="ex_scr_cost" value="0">
        </div>
      </div>
      <button class="main-btn" onclick="toggleExpStep(4)">‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‚ûî</button>
    </div>

    <div id="exp-step-4" style="display:none;">
      <div class="card" style="text-align:center;">
        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ö‡∏¥‡∏• (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡∏£‡∏π‡∏õ / ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3Mb)</label>
        <input type="file" id="ex_files" multiple accept="image/*" class="input-group">
        <button class="main-btn" onclick="summarizeExpenses()">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚ûî</button>
      </div>
    </div>

    <div id="exp-summary" style="display:none;">
      <div class="card" id="exp_sum_content"></div>
      <button class="main-btn" onclick="submitExpenseData()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <button class="main-btn back-btn" onclick="toggleExpStep(1)">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
  </div>

  <div id="page-capture" class="page">
    <h2>üì∏ Capture Report</h2>
    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</label>
    <select id="cap_date" class="input-group"></select>
    <div id="cap-results"></div>
    <button class="main-btn back-btn" onclick="goHome()">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
  </div>

  <div id="final-1" class="page" style="text-align:center;">
    <div style="font-size:60px; color:var(--success); margin:20px 0;"><i class="fas fa-check-circle"></i></div>
    <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2>
    <p>‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏°</p>
    <div style="background:#FFF3E0; padding:15px; border-radius:15px; border-left:5px solid #FF9800; margin:20px 0;">
      <h3 style="color:#E65100; margin:0;">üë∑‚Äç‚ôÇÔ∏è Safety First</h3>
      <p style="margin:5px 0;">‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö</p>
    </div>
    <button class="main-btn" onclick="goHome()">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
  </div>

  <div id="final-2" class="page" style="text-align:center;">
    <div style="font-size:60px; color:var(--success); margin:20px 0;"><i class="fas fa-paper-plane"></i></div>
    <h2>‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!</h2>
    <p>‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö</p>
    <button class="main-btn" onclick="goHome()">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
  </div>

  <div id="loader" class="loading"><i class="fas fa-spinner fa-spin fa-2x"></i><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p></div>
</div>

<script>
  let currentFlow = "", gpsData = {}, base64Images = [];

  function openFlow(flow) {
    const name = document.getElementById('main_name').value;
    const region = document.getElementById('main_region').value;
    if(!name || !region) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏Ñ‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
    
    currentFlow = flow;
    hideAllPages();
    
    if(['Site Check In', 'Check In', 'Check Out'].includes(flow)) {
      document.getElementById('check-title').innerText = flow;
      renderCheckFields(flow);
      document.getElementById('page-check').classList.add('active');
      getGPS();
    } else if(flow === 'Report') {
      document.getElementById('page-report').classList.add('active');
    } else if(flow === 'Expenses') {
      document.getElementById('page-expenses').classList.add('active');
      toggleExpStep(1);
    } else if(flow === 'Capture') {
      setupCapture();
    }
  }

  function renderCheckFields(flow) {
    let html = "";
    if(flow !== 'Site Check In') {
      html = `
        <label>‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£ (Buddy)</label><input type="text" id="c_buddy" class="input-group">
        <label>‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÉ‡∏Ñ‡∏£</label><input type="text" id="c_car" class="input-group">
        <label>‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå</label><input type="number" id="c_mile" class="input-group">
        <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà ${flow}</label><input type="text" id="c_place" class="input-group">
        <label>${flow === 'Check In' ? 'PLAN' : 'BRIEF'}</label><textarea id="c_plan" rows="3"></textarea>
      `;
    }
    document.getElementById('check-dynamic-fields').innerHTML = html;
  }

  // --- Image & GPS Logic ---
  function previewImage(input) {
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('preview-img').src = e.target.result;
        document.getElementById('preview-box').style.display = 'block';
        base64Images = [e.target.result];
      };
      reader.readAsDataURL(input.files[0]);
    }
  }

  function getGPS() {
    navigator.geolocation.getCurrentPosition(pos => {
      gpsData = {
        stamp: new Date().toLocaleString('th-TH'),
        code: pos.coords.latitude + "," + pos.coords.longitude,
        addr: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà..."
      };
      document.getElementById('gps-display').innerText = "üìç ‡∏û‡∏¥‡∏Å‡∏±‡∏î: " + gpsData.code;
    });
  }

  // --- Report Logic ---
  function nextReportStep() {
    if(document.getElementById('r_jobtype').value === '‡∏á‡∏≤‡∏ô CR') {
      hideAllPages();
      document.getElementById('page-report-cr').classList.add('active');
      renderCRSites(1);
    } else {
      submitReportData();
    }
  }

  function renderCRSites(n) {
    const cont = document.getElementById('cr-container');
    cont.innerHTML += `
      <div class="card" id="site-card-${n}">
        <h3>‡πÑ‡∏ã‡∏ï‡πå‡∏ó‡∏µ‡πà ${n}</h3>
        <label>‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏Ñ</label><select id="s_reg_${n}"><option>BKK</option><option>CR</option><option>ER</option><option>NER</option><option>NR</option><option>SR</option></select>
        <label>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ã‡∏ï‡πå</label><input type="text" id="s_name_${n}" class="input-group">
        <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label><input type="text" id="s_pro_${n}" class="input-group">
        <label>‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏á‡∏≤‡∏ô</label>
        <select id="s_job_${n}" onchange="toggleDiv('s_etc_div_${n}', this.value==='‡∏≠‡∏∑‡πà‡∏ô ‡πÜ')">
          <option>‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ô‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥ CR - CRL</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥ CR + ‡∏ô‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡∏ó‡∏≥‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥ CR + ‡∏ó‡∏≥‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà SA</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô (‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß)</option><option>‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
        </select>
        <div id="s_etc_div_${n}" style="display:none; margin-top:10px;"><label>‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô</label><input type="text" id="s_etc_${n}"></div>
        <label style="margin-top:10px;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</label><input type="text" id="s_det_${n}" class="input-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ô‡∏≥-‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input type="text" id="s_ld_${n}" class="input-group">
        ${n < 4 ? `<label>‡∏°‡∏µ‡πÑ‡∏ã‡∏ï‡πå‡∏ó‡∏µ‡πà ${n+1} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</label><select onchange="if(this.value.includes('‡∏°‡∏µ')) renderCRSites(${n+1}); this.disabled=true;"><option>‡πÑ‡∏°‡πà‡∏°‡∏µ/‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</option><option>‡∏°‡∏µ‡πÑ‡∏ã‡∏ï‡πå‡∏ó‡∏µ‡πà ${n+1}</option></select>` : ''}
        <button class="main-btn" onclick="submitReportData()">‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      </div>
    `;
  }

  // --- Expenses Logic ---
  function toggleExpStep(s) {
    for(let i=1; i<=4; i++) document.getElementById('exp-step-'+i).style.display = 'none';
    document.getElementById('exp-summary').style.display = 'none';
    document.getElementById('exp-step-'+s).style.display = 'block';
  }

  function summarizeExpenses() {
    const oil = Number(document.getElementById('ex_oil').value);
    const hotel = Number(document.getElementById('ex_hotel').value);
    const ccr = Number(document.getElementById('ex_ccr').value);
    const trav = Number(document.getElementById('ex_trav').value);
    const spc = Number(document.getElementById('ex_spc_cost').value);
    const nb = Number(document.getElementById('ex_nb_cost').value);
    const scr = Number(document.getElementById('ex_scr_cost').value);
    const total = oil + hotel + ccr + trav + spc + nb + scr;

    let html = `<h3>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h3>`;
    if(oil > 0) html += `<p>‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô: ${oil} ‡∏ö‡∏≤‡∏ó</p>`;
    if(hotel > 0) html += `<p>‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å: ${hotel} ‡∏ö‡∏≤‡∏ó</p>`;
    if(ccr > 0) html += `<p>‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°: ${ccr} ‡∏ö‡∏≤‡∏ó</p>`;
    if(trav > 0) html += `<p>‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á: ${trav} ‡∏ö‡∏≤‡∏ó</p>`;
    if(spc > 0) html += `<p>‡∏Ñ‡πà‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©: ${spc} ‡∏ö‡∏≤‡∏ó</p>`;
    if(nb > 0) html += `<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏¥‡∏•: ${nb} ‡∏ö‡∏≤‡∏ó</p>`;
    if(scr > 0) html += `<p>‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏° (SCR): ${scr} ‡∏ö‡∏≤‡∏ó</p>`;
    html += `<hr><h3 style="color:red;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô: ${total} ‡∏ö‡∏≤‡∏ó</h3>`;
    
    document.getElementById('exp_sum_content').innerHTML = html;
    toggleExpStep(0);
    document.getElementById('exp-summary').style.display = 'block';
  }

  // --- Data Submission ---
  function submitCheckData() {
    const data = getBasicData();
    data.buddy = document.getElementById('c_buddy')?.value || "";
    data.car = document.getElementById('c_car')?.value || "";
    data.mileage = document.getElementById('c_mile')?.value || "";
    data.place = document.getElementById('c_place')?.value || "";
    data.plan = document.getElementById('c_plan')?.value || "";
    data.images = base64Images;
    data.geoStamp = gpsData.stamp;
    data.geoCode = gpsData.code;
    data.geoAddress = gpsData.addr;
    
    sendToGas(data);
  }

  function submitReportData() {
    const data = getBasicData();
    data.status = "Report";
    data.buddy = document.getElementById('r_buddy').value;
    data.date = formatDate(document.getElementById('r_date').value); // Use selected date for Report
    data.extra = {
      15: document.getElementById('r_jobtype').value,
      16: document.getElementById('r_etc')?.value || "",
      17: document.getElementById('r_detail').value
    };
    
    // Add CR Site logic if applicable
    if(data.extra[15] === '‡∏á‡∏≤‡∏ô CR') {
      for(let i=1; i<=4; i++) {
        if(!document.getElementById('s_name_'+i)) break;
        data.extra[18] = document.getElementById('s_reg_1').value; // JobRegion
        let startCol = 19 + (i-1)*6; 
        data.extra[startCol] = document.getElementById('s_name_'+i).value;
        data.extra[startCol+1] = document.getElementById('s_pro_'+i).value;
        data.extra[startCol+2] = document.getElementById('s_job_'+i).value;
        data.extra[startCol+3] = document.getElementById('s_etc_'+i)?.value || "";
        data.extra[startCol+4] = document.getElementById('s_det_'+i).value;
        data.extra[startCol+5] = document.getElementById('s_ld_'+i).value;
      }
    }
    sendToGas(data);
  }

  function submitExpenseData() {
    const data = getBasicData();
    data.status = "Expenses";
    data.buddy = document.getElementById('ex_buddy').value;
    data.date = formatDate(document.getElementById('ex_date').value);
    data.extra = {
      15: document.getElementById('ex_jobtype').value,
      16: document.getElementById('ex_etc')?.value || "",
      17: document.getElementById('ex_detail').value,
      43: document.getElementById('ex_epsite').value,
      44: document.getElementById('ex_eppv').value,
      45: document.getElementById('ex_oil').value,
      46: document.getElementById('ex_hotel').value,
      47: document.getElementById('ex_ccr').value,
      48: document.getElementById('ex_trav').value,
      49: document.getElementById('ex_spc_type').value,
      50: document.getElementById('ex_spc_cost').value,
      51: document.getElementById('ex_nb_name').value,
      52: document.getElementById('ex_nb_cost').value,
      53: document.getElementById('ex_scr_type').value,
      54: document.getElementById('ex_scr_name').value,
      55: document.getElementById('ex_scr_date').value,
      56: document.getElementById('ex_scr_pro').value,
      57: document.getElementById('ex_scr_cost').value
    };
    
    const files = document.getElementById('ex_files').files;
    let loaded = 0;
    if(files.length > 0) {
      for(let f of files) {
        let reader = new FileReader();
        reader.onload = e => {
          base64Images.push(e.target.result);
          loaded++;
          if(loaded === files.length) {
            data.images = base64Images;
            sendToGas(data);
          }
        };
        reader.readAsDataURL(f);
      }
    } else { sendToGas(data); }
  }

  // --- Helpers ---
  function getBasicData() {
    return {
      name: document.getElementById('main_name').value,
      region: document.getElementById('main_region').value,
      status: currentFlow,
      date: new Date().toLocaleDateString('th-TH'),
      time: new Date().toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'}),
      device: /Mobi|Android/i.test(navigator.userAgent) ? "Mobile" : "PC"
    };
  }

  function sendToGas(payload) {
    document.getElementById('loader').style.display = "block";
    google.script.run.withSuccessHandler(res => {
      document.getElementById('loader').style.display = "none";
      hideAllPages();
      if(['Site Check In', 'Check In'].includes(currentFlow)) {
        document.getElementById('final-1').classList.add('active');
      } else {
        document.getElementById('final-2').classList.add('active');
      }
    }).processForm(payload);
  }

  function setupCapture() {
    const sel = document.getElementById('cap_date');
    sel.innerHTML = "";
    for(let i=0; i<8; i++) {
      let d = new Date(); d.setDate(d.getDate() - i);
      let ds = d.toLocaleDateString('th-TH');
      sel.innerHTML += `<option value="${ds}">${ds}</option>`;
    }
    document.getElementById('page-capture').classList.add('active');
  }

  function formatDate(val) { if(!val) return ""; let d = new Date(val); return d.toLocaleDateString('th-TH'); }
  function toggleDiv(id, show) { document.getElementById(id).style.display = show ? 'block' : 'none'; }
  function hideAllPages() { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); }
  function goHome() { location.reload(); }
</script>

</body>
</html>
