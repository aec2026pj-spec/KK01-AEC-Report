<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #0D47A1; --secondary: #1976D2; --success: #2E7D32; --warning: #FBC02D; --danger: #D32F2F; --bg: #f0f2f5; }
    body { font-family: 'Kanit', sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; }
    .container { max-width: 500px; margin: 0 auto; background: white; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); padding: 20px; box-sizing: border-box; }
    h1 { color: var(--primary); font-size: 24px; margin-bottom: 20px; border-bottom: 3px solid var(--warning); display: inline-block; padding-bottom: 5px; }
    
    /* Menu Styles */
    .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
    .btn-menu { border: none; border-radius: 18px; padding: 22px 10px; color: white; cursor: pointer; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); font-weight: 600; font-size: 15px; display: flex; flex-direction: column; align-items: center; gap: 8px; }
    .btn-menu:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .btn-site { background: linear-gradient(135deg, #00BCD4, #0097A7); }
    .btn-in { background: linear-gradient(135deg, #4CAF50, #388E3C); }
    .btn-out { background: linear-gradient(135deg, #FF9800, #F57C00); }
    .btn-rep { background: linear-gradient(135deg, #9C27B0, #7B1FA2); }
    .btn-exp { background: linear-gradient(135deg, #E91E63, #C2185B); }
    .btn-cap { background: linear-gradient(135deg, #607D8B, #455A64); }

    /* Form Styles */
    .input-group { text-align: left; margin-bottom: 15px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; color: #444; font-size: 14px; }
    input, select, textarea { width: 100%; padding: 14px; border: 2px solid #eee; border-radius: 12px; box-sizing: border-box; font-size: 16px; font-family: 'Kanit'; transition: 0.3s; }
    input:focus, select:focus { border-color: var(--secondary); outline: none; background: #fefefe; }
    .main-btn { background: var(--primary); color: white; width: 100%; padding: 16px; border: none; border-radius: 15px; font-size: 18px; font-weight: 600; margin-top: 10px; cursor: pointer; }
    
    .page { display: none; }
    .active { display: block; animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .summary-box { background: #f8f9fa; border: 1px dashed #ccc; border-radius: 12px; padding: 15px; text-align: left; margin: 15px 0; font-size: 14px; }
    .site-tag { background: var(--primary); color: white; padding: 2px 8px; border-radius: 5px; font-size: 12px; }
  </style>
</head>
<body>

<div class="container">
  <div id="page-home" class="page active">
    <h1>2026 AEC Report</h1>
    <div class="input-group">
      <label><i class="fas fa-user"></i> ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
      <input type="text" id="userName" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å">
    </div>
    <div class="input-group">
      <label><i class="fas fa-globe"></i> ‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</label>
      <select id="userRegion">
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ --</option>
        <option>BKK</option><option>CR</option><option>ER</option><option>NER</option>
        <option>NR</option><option>SR</option><option>TE</option><option>DR</option><option>OFFICE</option>
      </select>
    </div>

    <div class="menu-grid">
      <button class="btn-menu btn-site" onclick="startApp('Site Check In')"><i class="fas fa-map-marker-alt fa-2x"></i>Site Check In</button>
      <button class="btn-menu btn-in" onclick="startApp('Check In')"><i class="fas fa-sign-in-alt fa-2x"></i>Check In</button>
      <button class="btn-menu btn-out" onclick="startApp('Check Out')"><i class="fas fa-sign-out-alt fa-2x"></i>Check Out</button>
      <button class="btn-menu btn-rep" onclick="startApp('Report')"><i class="fas fa-file-signature fa-2x"></i>Report</button>
      <button class="btn-menu btn-exp" onclick="startApp('Expenses')"><i class="fas fa-wallet fa-2x"></i>Expenses</button>
      <button class="btn-menu btn-cap" onclick="startApp('Capture')"><i class="fas fa-camera fa-2x"></i>Capture</button>
    </div>
  </div>

  <div id="page-form-standard" class="page">
    <h2 id="form-title"></h2>
    <div id="standard-fields"></div>
    <div class="input-group">
      <label>üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û</label>
      <input type="file" id="camera-file" accept="image/*" capture="camera" onchange="handleImage(this)">
    </div>
    <div id="gps-preview" style="display:none; margin:10px 0;">
      <p id="gps-text" style="font-size:12px; color:blue;"></p>
      <img id="img-preview" style="max-width:100%; border-radius:10px; border:2px solid #ddd;">
    </div>
    <button class="main-btn" onclick="submitStandard()">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• <i class="fas fa-paper-plane"></i></button>
    <button class="main-btn" style="background:#888;" onclick="location.reload()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
  </div>

  <div id="page-report" class="page">
    <h2>üìù ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (Report)</h2>
    <div id="report-step-1">
      <label>‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£</label><input type="text" id="r_buddy">
      <label>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="r_date">
      <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</label>
      <select id="r_jobtype" onchange="toggleJobEtc(this.value)">
        <option>‡∏á‡∏≤‡∏ô CR</option><option>‡∏á‡∏≤‡∏ô OFFICE</option><option>‡∏á‡∏≤‡∏ô TE</option><option>‡∏á‡∏≤‡∏ô DRONE</option><option>‡∏á‡∏≤‡∏ô ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
      </select>
      <input type="text" id="r_etc" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô" style="display:none;">
      <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</label><textarea id="r_detail"></textarea>
      <button class="main-btn" onclick="nextReportStep()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ûî</button>
    </div>
    <div id="report-step-cr" style="display:none;">
      <label>‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏Ñ</label>
      <select id="r_jobreg"><option>BKK</option><option>CR</option><option>ER</option><option>NER</option><option>NR</option><option>SR</option></select>
      <div id="site-questions-container"></div>
    </div>
  </div>

  <div id="page-expenses" class="page">
    <h2>üí∞ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (Expenses)</h2>
    <div id="exp-step-1">
      <label>‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£</label><input type="text" id="ex_buddy">
      <label>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="ex_date">
      <label>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ã‡∏ï‡πå</label><input type="text" id="ex_sitename">
      <label>‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏£‡∏ñ</label><input type="number" id="ex_oil" value="0">
      <label>‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å</label><input type="number" id="ex_hotel" value="0">
      <label>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©</label>
      <select id="ex_spc"><option>‡πÑ‡∏°‡πà‡∏°‡∏µ</option><option>‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option><option>‡∏ó‡∏≥‡∏ü‡∏±‡∏ô</option></select>
      <button class="main-btn" onclick="nextExpStep()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ) ‚ûî</button>
    </div>
    <div id="exp-step-2" style="display:none;">
      <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ö‡∏¥‡∏• (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10 ‡∏£‡∏π‡∏õ)</label>
      <input type="file" id="ex_files" multiple accept="image/*">
      <button class="main-btn" onclick="summaryExpenses()">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î ‚ûî</button>
    </div>
    <div id="exp-summary" style="display:none;">
       <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</h3>
       <div id="exp-sum-list" class="summary-box"></div>
       <button class="main-btn" onclick="submitExpenses()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
       <button class="main-btn" style="background:#D32F2F;" onclick="location.reload()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
    </div>
  </div>

  <div id="page-capture" class="page">
    <h2>üì∏ Capture Report</h2>
    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</label>
    <select id="cap_date_select"></select>
    <button class="main-btn" onclick="fetchCaptureData()">‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <div id="capture-result" style="margin-top:20px;"></div>
    <button class="main-btn" style="background:#888; margin-top:20px;" onclick="location.reload()">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
  </div>

  <div id="page-final" class="page" style="text-align:center;">
    <div id="final-icon" style="font-size:80px; margin:20px 0;"></div>
    <h2 id="final-msg"></h2>
    <p id="final-sub"></p>
    <button class="main-btn" onclick="location.reload()">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
  </div>

</div>

<script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyi7bfX6U_-iFVAu0C54itxe8nj1wdSQhDKfenDMtKvjo8JDLFSrxykcG-Go-Qzb1fe/exec";
  let curStatus = "";
  let base64Img = "";
  let gpsData = { lat:"", lng:"", addr:"", full:"" };
  let siteCounter = 1;

  // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏Ñ
  window.onload = () => {
    if(localStorage.getItem('aec_name')) document.getElementById('userName').value = localStorage.getItem('aec_name');
    if(localStorage.getItem('aec_reg')) document.getElementById('userRegion').value = localStorage.getItem('aec_reg');
    setupCaptureDates();
  };

  function startApp(status) {
    const name = document.getElementById('userName').value;
    const reg = document.getElementById('userRegion').value;
    if(!name || !reg) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏Ñ‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î"); return; }
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
    localStorage.setItem('aec_name', name);
    localStorage.setItem('aec_reg', reg);
    
    curStatus = status;
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    
    if(['Site Check In','Check In','Check Out'].includes(status)) {
      showStandardForm(status);
    } else if(status === 'Report') {
      document.getElementById('page-report').classList.add('active');
    } else if(status === 'Expenses') {
      document.getElementById('page-expenses').classList.add('active');
    } else if(status === 'Capture') {
      document.getElementById('page-capture').classList.add('active');
    }
  }

  // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1-3: Standard Forms ---
  function showStandardForm(st) {
    const page = document.getElementById('page-form-standard');
    document.getElementById('form-title').innerText = "üìç " + st;
    let html = "";
    if(st !== 'Site Check In') {
      html = `
        <label>‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£</label><input type="text" id="f_buddy">
        <label>‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÉ‡∏Ñ‡∏£</label><input type="text" id="f_car">
        <label>‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå</label><input type="number" id="f_mile">
        <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà ${st}</label><input type="text" id="f_place">
        <label>${st === 'Check In' ? 'PLAN' : 'BRIFE'}</label><textarea id="f_plan"></textarea>
      `;
    }
    document.getElementById('standard-fields').innerHTML = html;
    page.classList.add('active');
    getGPS();
  }

  function getGPS() {
    navigator.geolocation.getCurrentPosition(p => {
      gpsData.lat = p.coords.latitude;
      gpsData.lng = p.coords.longitude;
      gpsData.full = gpsData.lat + "," + gpsData.lng;
    }, err => alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS"));
  }

  function handleImage(input) {
    const reader = new FileReader();
    reader.onload = e => {
      base64Img = e.target.result;
      document.getElementById('img-preview').src = base64Img;
      document.getElementById('gps-text').innerText = "‡∏û‡∏¥‡∏Å‡∏±‡∏î: " + gpsData.full;
      document.getElementById('gps-preview').style.display = 'block';
    };
    reader.readAsDataURL(input.files[0]);
  }

  function submitStandard() {
    const d = new Array(60).fill("");
    const now = new Date();
    d[0] = now.toLocaleDateString('th-TH'); d[1] = now.getHours()+":"+now.getMinutes();
    d[2] = localStorage.getItem('aec_name'); d[3] = localStorage.getItem('aec_reg');
    d[4] = curStatus; d[5] = gpsData.full; d[6] = gpsData.full;
    if(curStatus !== 'Site Check In') {
      d[10] = document.getElementById('f_buddy').value;
      d[11] = document.getElementById('f_car').value;
      d[12] = document.getElementById('f_mile').value;
      d[13] = document.getElementById('f_place').value;
      d[14] = document.getElementById('f_plan').value;
    }
    sendToSheet(d, base64Img);
  }

  // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 4: Report ---
  function toggleJobEtc(val) { document.getElementById('r_etc').style.display = (val === '‡∏á‡∏≤‡∏ô ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ' ? 'block' : 'none'); }
  
  function nextReportStep() {
    const type = document.getElementById('r_jobtype').value;
    if(type === '‡∏á‡∏≤‡∏ô CR') {
      document.getElementById('report-step-1').style.display = 'none';
      document.getElementById('report-step-cr').style.display = 'block';
      renderSiteQuestion(1);
    } else {
      submitReportFinal();
    }
  }

  function renderSiteQuestion(n) {
    const cont = document.getElementById('site-questions-container');
    const div = document.createElement('div');
    div.innerHTML = `
      <div class="summary-box">
        <span class="site-tag">‡πÑ‡∏ã‡∏ï‡πå‡∏ó‡∏µ‡πà ${n}</span>
        <input type="text" id="s_name_${n}" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ã‡∏ï‡πå">
        <input type="text" id="s_prov_${n}" placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î">
        <select id="s_job_${n}"><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥ CR - CRL</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡∏ó‡∏≥‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°</option><option>‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option></select>
        <textarea id="s_det_${n}" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô"></textarea>
        <input type="text" id="s_ld_${n}" placeholder="‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£">
        <select id="s_next_${n}" onchange="if(this.value=='‡∏°‡∏µ‡πÑ‡∏ã‡∏ï‡πå‡∏ó‡∏µ‡πà ${n+1}') renderSiteQuestion(${n+1})">
          <option>‡πÑ‡∏°‡πà‡∏°‡∏µ/‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</option><option>‡∏°‡∏µ‡πÑ‡∏ã‡∏ï‡πå‡∏ó‡∏µ‡πà ${n+1}</option>
        </select>
      </div>
    `;
    cont.appendChild(div);
  }

  function submitReportFinal() {
    const d = new Array(60).fill("");
    d[0] = document.getElementById('r_date').value; d[2] = localStorage.getItem('aec_name');
    d[3] = localStorage.getItem('aec_reg'); d[4] = "Report";
    d[10] = document.getElementById('r_buddy').value; d[15] = document.getElementById('r_jobtype').value;
    d[17] = document.getElementById('r_detail').value;
    sendToSheet(d, "");
  }

  // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 6: Capture ---
  function setupCaptureDates() {
    const sel = document.getElementById('cap_date_select');
    for(let i=0; i<8; i++) {
      let d = new Date(); d.setDate(d.getDate() - i);
      let ds = d.toLocaleDateString('th-TH');
      sel.innerHTML += `<option value="${ds}">${ds}</option>`;
    }
  }

  // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ß‡∏° ---
  function sendToSheet(values, img) {
    document.body.innerHTML = "<div class='container'><h2>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</h2></div>";
    fetch(WEB_APP_URL, { method:'POST', mode:'no-cors', body: JSON.stringify({
      values: values, region: values[3], status: values[4], image: img
    })}).then(() => {
       location.reload(); // ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å showFinal()
    });
  }
</script>
</body>
</html>
