<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>2026 AEC Report</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root { --p1: #1e3a8a; --p2: #3b82f6; --acc: #facc15; --succ: #22c55e; --dang: #ef4444; --bg: #f8fafc; }
    body { font-family: 'Kanit', sans-serif; background: var(--bg); margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    .container { max-width: 500px; margin: 0 auto; padding: 15px; box-sizing: border-box; }
    .card { background: white; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
    h1 { color: var(--p1); text-align: center; font-size: 26px; margin: 15px 0; font-weight: 600; }
    h2 { font-size: 18px; color: var(--p2); border-left: 5px solid var(--acc); padding-left: 10px; margin-bottom: 20px; }
    
    label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px; color: #475569; }
    input, select, textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 12px; font-size: 16px; font-family: 'Kanit'; box-sizing: border-box; margin-bottom: 15px; }
    input:focus { border-color: var(--p2); outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    
    .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
    .btn-menu { border: none; border-radius: 18px; padding: 25px 10px; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 10px; transition: 0.2s; font-weight: 600; font-size: 14px; }
    .btn-menu:active { transform: scale(0.95); }
    .bg-blue { background: linear-gradient(135deg, #0284c7, #075985); }
    .bg-green { background: linear-gradient(135deg, #16a34a, #14532d); }
    .bg-orange { background: linear-gradient(135deg, #ea580c, #9a3412); }
    .bg-purple { background: linear-gradient(135deg, #9333ea, #581c87); }
    .bg-pink { background: linear-gradient(135deg, #db2777, #831843); }
    .bg-slate { background: linear-gradient(135deg, #475569, #1e293b); }
    
    .btn-main { background: var(--p1); color: white; border: none; width: 100%; padding: 15px; border-radius: 12px; font-size: 18px; font-weight: 600; cursor: pointer; margin-top: 10px; }
    .btn-back { background: #e2e8f0; color: #475569; }
    
    .preview-box { background: #f1f5f9; border-radius: 12px; padding: 10px; text-align: center; margin-bottom: 15px; display: none; }
    .preview-img { max-width: 100%; border-radius: 8px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    
    #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.8); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
    .spin { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--p1); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .page { display: none; }
    .active { display: block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    table { width: 100%; border-collapse: collapse; font-size: 12px; background: white; }
    th, td { border: 1px solid #e2e8f0; padding: 8px; text-align: left; }
    th { background: var(--p1); color: white; }
    .scroll-x { overflow-x: auto; border-radius: 10px; margin-top: 10px; }
  </style>
</head>
<body>

<div id="loader"><div class="spin"></div><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p></div>

<div class="container">
  <div id="page-home" class="page active">
    <h1>2026 AEC Report</h1>
    <div class="card">
      <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô (Name)</label>
      <input type="text" id="main_name" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
      <label>‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î (Region)</label>
      <select id="main_region">
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ --</option>
        <option>BKK</option><option>CR</option><option>ER</option><option>NER</option><option>NR</option><option>SR</option><option>TE</option><option>DR</option><option>OFFICE</option>
      </select>
    </div>
    <div class="menu-grid">
      <button class="btn-menu bg-blue" onclick="navTo('check', 'Site Check In')"><i class="fas fa-map-marker-alt fa-2x"></i>Site Check In</button>
      <button class="btn-menu bg-green" onclick="navTo('check', 'Check In')"><i class="fas fa-sign-in-alt fa-2x"></i>Check In</button>
      <button class="btn-menu bg-orange" onclick="navTo('check', 'Check Out')"><i class="fas fa-sign-out-alt fa-2x"></i>Check Out</button>
      <button class="btn-menu bg-purple" onclick="navTo('report')"><i class="fas fa-clipboard-list fa-2x"></i>Report</button>
      <button class="btn-menu bg-pink" onclick="navTo('expenses')"><i class="fas fa-wallet fa-2x"></i>Expenses</button>
      <button class="btn-menu bg-slate" onclick="navTo('capture')"><i class="fas fa-camera fa-2x"></i>Capture</button>
    </div>
  </div>

  <div id="page-check" class="page">
    <h2 id="check-title">Check In</h2>
    <div id="check-form-fields"></div>
    <div class="card">
      <label>üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏Å‡∏±‡∏î</label>
      <input type="file" id="check_file" accept="image/*" capture="camera" onchange="previewFile(this, 'check_prev')">
      <div id="check_prev_div" class="preview-box">
        <img id="check_prev" class="preview-img">
        <p id="gps_display" style="font-size:12px; color:var(--p1); margin-top:5px;"></p>
      </div>
    </div>
    <button class="btn-main" onclick="submitCheck()">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <button class="btn-main btn-back" onclick="goHome()">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
  </div>

  <div id="page-report" class="page">
    <h2>üìù ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏• (Report)</h2>
    <div class="card">
      <label>‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£ (Buddy)</label><input type="text" id="rep_buddy">
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label><input type="date" id="rep_date">
      <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</label>
      <select id="rep_job" onchange="toggleDiv('rep_etc_div', this.value==='‡∏á‡∏≤‡∏ô ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ')">
        <option>‡∏á‡∏≤‡∏ô CR</option><option>‡∏á‡∏≤‡∏ô OFFICE</option><option>‡∏á‡∏≤‡∏ô TE</option><option>‡∏á‡∏≤‡∏ô DRONE</option><option>‡∏á‡∏≤‡∏ô ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
      </select>
      <div id="rep_etc_div" style="display:none;"><label>‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô</label><input type="text" id="rep_etc"></div>
      <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</label><textarea id="rep_detail" rows="3"></textarea>
    </div>
    <button class="btn-main" onclick="handleReportNext()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ûî</button>
    <button class="btn-main btn-back" onclick="goHome()">‡∏Å‡∏•‡∏±‡∏ö</button>
  </div>

  <div id="page-report-cr" class="page">
    <h2 id="cr-site-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô CR (‡πÑ‡∏ã‡∏ï‡πå‡∏ó‡∏µ‡πà 1)</h2>
    <div class="card" id="cr-form-area">
      </div>
    <button class="btn-main" onclick="processCRSite()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ / ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
  </div>

  <div id="page-expenses" class="page">
    <h2>üí∞ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (Expenses)</h2>
    <div id="exp-step-1">
      <div class="card">
        <label>‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£ (Buddy)</label><input type="text" id="exp_buddy">
        <label>‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="exp_date">
        <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</label>
        <select id="exp_job" onchange="toggleDiv('exp_etc_div', this.value==='‡∏á‡∏≤‡∏ô ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ')">
          <option>‡∏á‡∏≤‡∏ô CR</option><option>‡∏á‡∏≤‡∏ô OFFICE</option><option>‡∏á‡∏≤‡∏ô TE</option><option>‡∏á‡∏≤‡∏ô DRONE</option><option>‡∏á‡∏≤‡∏ô ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
        </select>
        <div id="exp_etc_div" style="display:none;"><label>‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô</label><input type="text" id="exp_etc"></div>
        <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</label><textarea id="exp_detail" rows="2"></textarea>
      </div>
      <div class="card">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ã‡∏ï‡πå</label><input type="text" id="exp_site">
        <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label><input type="text" id="exp_pv">
        <label>‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô (No.1)</label><input type="number" id="exp_oil" value="0">
        <label>‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å (No.2)</label><input type="number" id="exp_hotel" value="0">
        <label>‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏° (No.3)</label><input type="number" id="exp_ccr" value="0">
        <label>‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á (No.4)</label><input type="number" id="exp_trav" value="0">
      </div>
      <button class="btn-main" onclick="showExpStep(2)">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ûî</button>
    </div>

    <div id="exp-step-2" style="display:none;">
      <div class="card">
        <label>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©</label>
        <select id="exp_spc_type" onchange="toggleDiv('exp_spc_val_div', this.value!=='‡πÑ‡∏°‡πà‡∏°‡∏µ')">
          <option>‡πÑ‡∏°‡πà‡∏°‡∏µ</option><option>‡πÄ‡∏ö‡∏¥‡∏Å‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô/‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡∏°/‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ</option><option>‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option><option>‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤</option><option>‡∏ó‡∏≥‡∏ü‡∏±‡∏ô (‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£)</option><option>‡∏Ñ‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•/‡∏Ñ‡πà‡∏≤‡∏¢‡∏≤ (‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£)</option><option>‡∏Ñ‡πà‡∏≤‡∏™‡∏±‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡∏≤‡∏£/‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á (‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß)</option><option>‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</option><option>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏µ/‡∏õ‡∏Å‡∏™.‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</option>
        </select>
        <div id="exp_spc_val_div" style="display:none;"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label><input type="number" id="exp_spc_val" value="0"></div>
      </div>
      <div class="card">
        <label>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏¥‡∏• (‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß)</label>
        <select id="exp_nb_type" onchange="toggleDiv('exp_nb_val_div', this.value!=='‡πÑ‡∏°‡πà‡∏°‡∏µ')"><option>‡πÑ‡∏°‡πà‡∏°‡∏µ</option><option>‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏¥‡∏•</option></select>
        <div id="exp_nb_val_div" style="display:none;">
          <label>‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</label><input type="text" id="exp_nb_name">
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label><input type="number" id="exp_nb_val" value="0">
        </div>
      </div>
      <div class="card">
        <label>‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°</label>
        <select id="exp_scr_type" onchange="toggleDiv('exp_scr_val_div', this.value!=='‡πÑ‡∏°‡πà‡∏°‡∏µ')"><option>‡πÑ‡∏°‡πà‡∏°‡∏µ</option><option>‡∏°‡∏µ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°</option></select>
        <div id="exp_scr_val_div" style="display:none;">
          <label>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ã‡∏ï‡πå</label><input type="text" id="exp_scr_name">
          <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢</label><input type="date" id="exp_scr_date">
          <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label><input type="text" id="exp_scr_pro">
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label><input type="number" id="exp_scr_cost" value="0">
        </div>
      </div>
      <button class="btn-main" onclick="showExpStep(3)">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ ‚ûî</button>
    </div>

    <div id="exp-step-3" style="display:none;">
      <div class="card">
        <label>üì∏ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ö‡∏¥‡∏• (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡∏£‡∏π‡∏õ / ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3MB)</label>
        <input type="file" id="exp_files" multiple accept="image/*" onchange="previewMultiFile(this)">
        <div id="exp_multi_prev_div" class="preview-box">
          <img id="exp_multi_prev" class="preview-img">
          <p id="exp_count_text"></p>
        </div>
      </div>
      <button class="btn-main" onclick="summarizeExp()">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚ûî</button>
    </div>

    <div id="exp-step-summary" style="display:none;">
      <div class="card" id="exp_final_summary" style="line-height:1.8;"></div>
      <button class="btn-main" onclick="submitExp()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <button class="btn-main btn-back" onclick="showExpStep(1)">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
  </div>

  <div id="page-capture" class="page">
    <h2>üì∏ Capture Report</h2>
    <div class="card">
      <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label>
      <select id="cap_date_sel"></select>
      <button class="btn-main" style="background:#0891b2;" onclick="fetchCaptureData()">‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
    <div id="cap_results_area" class="scroll-x"></div>
    <button class="btn-main btn-back" onclick="goHome()" style="margin-top:20px;">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
  </div>

  <div id="page-final-1" class="page">
    <div class="card" style="text-align:center;">
      <i class="fas fa-check-circle fa-4x" style="color:var(--succ)"></i>
      <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2>
      <p>‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏°‡∏Ñ‡∏£‡∏±‡∏ö</p>
      <div style="background:#fff7ed; padding:15px; border-radius:15px; color:#c2410c; font-weight:600; margin:15px 0;">
        ‚ö†Ô∏è Safety First! ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö
      </div>
      <button class="btn-main" onclick="goHome()">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
    </div>
  </div>

  <div id="page-final-2" class="page">
    <div class="card" style="text-align:center;">
      <i class="fas fa-paper-plane fa-4x" style="color:var(--p2)"></i>
      <h2>‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!</h2>
      <p>‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö</p>
      <button class="btn-main" onclick="goHome()">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
    </div>
  </div>

</div>

<script>
  let currentStatus = "";
  let currentImgs = [];
  let currentGPS = { stamp: "", code: "", addr: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." };
  let crSiteIndex = 1;
  let crTempData = {};

  // Initial
  window.onload = () => {
    const savedName = localStorage.getItem('kk02_name');
    const savedReg = localStorage.getItem('kk02_region');
    if(savedName) document.getElementById('main_name').value = savedName;
    if(savedReg) document.getElementById('main_region').value = savedReg;

    // Date Dropdown for Capture
    const sel = document.getElementById('cap_date_sel');
    for(let i=0; i<8; i++) {
      let d = new Date(); d.setDate(d.getDate() - i);
      let ds = d.toLocaleDateString('th-TH');
      sel.innerHTML += `<option value="${ds}">${ds}</option>`;
    }
  };

  function saveProfile() {
    const name = document.getElementById('main_name').value;
    const reg = document.getElementById('main_region').value;
    if(!name || !reg) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ"); return null; }
    localStorage.setItem('kk02_name', name);
    localStorage.setItem('kk02_region', reg);
    return { name, reg };
  }

  function navTo(pageId, status = "") {
    if(!saveProfile()) return;
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-' + pageId).classList.add('active');
    if(status) {
      currentStatus = status;
      document.getElementById('check-title').innerText = status;
      renderCheckForm(status);
    }
    window.scrollTo(0,0);
  }

  function renderCheckForm(status) {
    const area = document.getElementById('check-form-fields');
    if(status === 'Site Check In') {
      area.innerHTML = "";
    } else {
      const isOut = status.includes('Out');
      area.innerHTML = `
        <div class="card">
          <label>‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£</label><input type="text" id="c_buddy">
          <label>‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÉ‡∏Ñ‡∏£</label><input type="text" id="c_car">
          <label>‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå</label><input type="number" id="c_mile">
          <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà ${status}</label><input type="text" id="c_place">
          <label>${isOut ? 'BRIFE' : 'PLAN'}</label><textarea id="c_plan"></textarea>
        </div>
      `;
    }
    currentImgs = [];
    document.getElementById('check_prev_div').style.display = 'none';
  }

  async function previewFile(input, imgId) {
    if(input.files && input.files[0]) {
      const file = input.files[0];
      if(file.size > 3*1024*1024) { alert("‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3MB"); input.value=""; return; }
      
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById(imgId).src = e.target.result;
        document.getElementById(imgId + '_div').style.display = 'block';
        currentImgs = [e.target.result];
      };
      reader.readAsDataURL(file);
      getGPS();
    }
  }

  async function previewMultiFile(input) {
    currentImgs = [];
    if(input.files.length > 10) { alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10 ‡∏£‡∏π‡∏õ"); input.value=""; return; }
    
    for(let f of input.files) {
      if(f.size > 3*1024*1024) continue;
      const b64 = await new Promise(r => {
        const rd = new FileReader(); rd.onload = () => r(rd.result); rd.readAsDataURL(f);
      });
      currentImgs.push(b64);
    }
    if(currentImgs.length > 0) {
      document.getElementById('exp_multi_prev').src = currentImgs[0];
      document.getElementById('exp_multi_prev_div').style.display = 'block';
      document.getElementById('exp_count_text').innerText = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${currentImgs.length} ‡∏£‡∏π‡∏õ (‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏£‡∏Å)`;
    }
  }

  function getGPS() {
    document.getElementById('gps_display').innerText = "‚åõ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î...";
    navigator.geolocation.getCurrentPosition(pos => {
      currentGPS.code = pos.coords.latitude + "," + pos.coords.longitude;
      currentGPS.stamp = new Date().toLocaleString('th-TH');
      document.getElementById('gps_display').innerText = "üìç " + currentGPS.code;
    }, err => {
      currentGPS.code = "0,0";
      document.getElementById('gps_display').innerText = "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ";
    }, {enableHighAccuracy: true});
  }

  function submitCheck() {
    const prof = saveProfile();
    if(currentImgs.length === 0) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û"); return; }
    
    const payload = {
      date: new Date().toLocaleDateString('th-TH'),
      time: new Date().toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'}),
      name: prof.name, region: prof.reg, status: currentStatus,
      geoStamp: currentGPS.stamp, geoCode: currentGPS.code, geoAddress: currentGPS.addr,
      device: /Mobi|Android/i.test(navigator.userAgent) ? "Mobile" : "PC",
      images: currentImgs,
      buddy: document.getElementById('c_buddy')?.value || "",
      car: document.getElementById('c_car')?.value || "",
      mileage: document.getElementById('c_mile')?.value || "",
      place: document.getElementById('c_place')?.value || "",
      plan: document.getElementById('c_plan')?.value || ""
    };
    
    const finalType = currentStatus.includes('Out') ? '2' : '1';
    callGas(payload, finalType);
  }

  // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 4: Report ---
  function handleReportNext() {
    const job = document.getElementById('rep_job').value;
    if(job === '‡∏á‡∏≤‡∏ô CR') {
      crSiteIndex = 1;
      crTempData = {};
      navTo('report-cr');
      renderCRSiteForm(1);
    } else {
      submitReportGeneric();
    }
  }

  function renderCRSiteForm(n) {
    document.getElementById('cr-site-title').innerText = `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô CR (‡πÑ‡∏ã‡∏ï‡πå‡∏ó‡∏µ‡πà ${n})`;
    const area = document.getElementById('cr-form-area');
    area.innerHTML = `
      ${n===1 ? `<label>‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏Ñ</label><select id="s_reg"><option>BKK</option><option>CR</option><option>ER</option><option>NER</option><option>NR</option><option>SR</option></select>` : ''}
      <label>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ã‡∏ï‡πå</label><input type="text" id="s_name">
      <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label><input type="text" id="s_prov">
      <label>‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏á‡∏≤‡∏ô</label>
      <select id="s_job" onchange="toggleDiv('s_etc_site_div', this.value==='‡∏≠‡∏∑‡πà‡∏ô ‡πÜ')">
        <option>‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ô‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥ CR - CRL</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥ CR + ‡∏ô‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡∏ó‡∏≥‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥ CR + ‡∏ó‡∏≥‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà SA</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô (‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß)</option><option>‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
      </select>
      <div id="s_etc_site_div" style="display:none;"><label>‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô</label><input type="text" id="s_etc_site"></div>
      <label>‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</label><input type="text" id="s_detail">
      <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ô‡∏≥-‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input type="text" id="s_ld">
      ${n < 4 ? `<label>‡∏°‡∏µ‡πÑ‡∏ã‡∏ï‡πå‡∏ó‡∏µ‡πà ${n+1} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà</label><select id="s_next"><option value="no">‡πÑ‡∏°‡πà‡∏°‡∏µ/‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</option><option value="yes">‡∏°‡∏µ‡πÑ‡∏ã‡∏ï‡πå‡∏ó‡∏µ‡πà ${n+1}</option></select>` : ''}
    `;
  }

  function processCRSite() {
    const n = crSiteIndex;
    if(n === 1) crTempData[18] = document.getElementById('s_reg').value;
    
    const startIdx = 19 + (n-1)*6; // T, U, V, W, X, Y...
    crTempData[startIdx] = document.getElementById('s_name').value;
    crTempData[startIdx+1] = document.getElementById('s_prov').value;
    crTempData[startIdx+2] = document.getElementById('s_job').value;
    crTempData[startIdx+3] = document.getElementById('s_etc_site')?.value || "";
    crTempData[startIdx+4] = document.getElementById('s_detail').value;
    crTempData[startIdx+5] = document.getElementById('s_ld').value;

    const next = document.getElementById('s_next')?.value || 'no';
    if(next === 'yes' && n < 4) {
      crSiteIndex++;
      renderCRSiteForm(crSiteIndex);
      window.scrollTo(0,0);
    } else {
      submitReportGeneric(crTempData);
    }
  }

  function submitReportGeneric(crData = {}) {
    const prof = saveProfile();
    const payload = {
      date: formatDate(document.getElementById('rep_date').value),
      time: "", name: prof.name, region: prof.reg, status: "Report",
      device: /Mobi|Android/i.test(navigator.userAgent) ? "Mobile" : "PC",
      buddy: document.getElementById('rep_buddy').value,
      extra: {
        15: document.getElementById('rep_job').value,
        16: document.getElementById('rep_etc')?.value || "",
        17: document.getElementById('rep_detail').value,
        ...crData
      }
    };
    callGas(payload, '2');
  }

  // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 5: Expenses ---
  function showExpStep(n) {
    document.getElementById('exp-step-1').style.display = n===1 ? 'block' : 'none';
    document.getElementById('exp-step-2').style.display = n===2 ? 'block' : 'none';
    document.getElementById('exp-step-3').style.display = n===3 ? 'block' : 'none';
    document.getElementById('exp-step-summary').style.display = 'none';
    window.scrollTo(0,0);
  }

  function summarizeExp() {
    if(currentImgs.length === 0) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ö‡∏¥‡∏•"); return; }
    const oil = Number(document.getElementById('exp_oil').value) || 0;
    const hot = Number(document.getElementById('exp_hotel').value) || 0;
    const ccr = Number(document.getElementById('exp_ccr').value) || 0;
    const trv = Number(document.getElementById('exp_trav').value) || 0;
    const spc = Number(document.getElementById('exp_spc_val').value) || 0;
    const nb = Number(document.getElementById('exp_nb_val').value) || 0;
    const scr = Number(document.getElementById('exp_scr_cost').value) || 0;
    const total = oil+hot+ccr+trv+spc+nb+scr;

    let html = `<h3>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h3><hr>`;
    if(oil>0) html += `<p>‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô: ${oil} ‡∏ö‡∏≤‡∏ó</p>`;
    if(hot>0) html += `<p>‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å: ${hot} ‡∏ö‡∏≤‡∏ó</p>`;
    if(ccr>0) html += `<p>‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°: ${ccr} ‡∏ö‡∏≤‡∏ó</p>`;
    if(trv>0) html += `<p>‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á: ${trv} ‡∏ö‡∏≤‡∏ó</p>`;
    if(spc>0) html += `<p>‡∏Ñ‡πà‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏© (${document.getElementById('exp_spc_type').value}): ${spc} ‡∏ö‡∏≤‡∏ó</p>`;
    if(nb>0) html += `<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏¥‡∏• (${document.getElementById('exp_nb_name').value}): ${nb} ‡∏ö‡∏≤‡∏ó</p>`;
    if(scr>0) html += `<p>‡∏Ñ‡πà‡∏≤‡∏õ‡∏ä‡∏Ñ. (${document.getElementById('exp_scr_name').value}): ${scr} ‡∏ö‡∏≤‡∏ó</p>`;
    html += `<hr><p style="font-size:20px; color:var(--dang)"><b>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${total} ‡∏ö‡∏≤‡∏ó</b></p>`;
    html += `<p>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏π‡∏õ: ${currentImgs.length} ‡∏£‡∏π‡∏õ</p>`;

    document.getElementById('exp_final_summary').innerHTML = html;
    document.getElementById('exp-step-3').style.display = 'none';
    document.getElementById('exp-step-summary').style.display = 'block';
  }

  function submitExp() {
    const prof = saveProfile();
    const payload = {
      date: formatDate(document.getElementById('exp_date').value),
      time: "", name: prof.name, region: prof.reg, status: "Expenses",
      device: /Mobi|Android/i.test(navigator.userAgent) ? "Mobile" : "PC",
      buddy: document.getElementById('exp_buddy').value,
      images: currentImgs,
      extra: {
        15: document.getElementById('exp_job').value,
        16: document.getElementById('exp_etc')?.value || "",
        17: document.getElementById('exp_detail').value,
        43: document.getElementById('exp_site').value,
        44: document.getElementById('exp_pv').value,
        45: document.getElementById('exp_oil').value,
        46: document.getElementById('exp_hotel').value,
        47: document.getElementById('exp_ccr').value,
        48: document.getElementById('exp_trav').value,
        49: document.getElementById('exp_spc_type').value,
        50: document.getElementById('exp_spc_val').value,
        51: document.getElementById('exp_nb_name').value,
        52: document.getElementById('exp_nb_val').value,
        53: document.getElementById('exp_scr_type').value,
        54: document.getElementById('exp_scr_name').value,
        55: formatDate(document.getElementById('exp_scr_date').value),
        56: document.getElementById('exp_scr_pro').value,
        57: document.getElementById('exp_scr_cost').value
      }
    };
    callGas(payload, '2');
  }

  // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 6: Capture ---
  function fetchCaptureData() {
    const date = document.getElementById('cap_date_sel').value;
    document.getElementById('loader').style.display = 'flex';
    google.script.run.withSuccessHandler(res => {
      document.getElementById('loader').style.display = 'none';
      if(res.rows.length === 0) { 
        document.getElementById('cap_results_area').innerHTML = "<p style='text-align:center; padding:20px;'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>";
        return; 
      }
      let h = "<table><tr>" + res.headers.slice(0,15).map(t => `<th>${t}</th>`).join('') + "</tr>";
      res.rows.forEach(r => {
        h += "<tr>" + r.slice(0,15).map(v => `<td>${v}</td>`).join('') + "</tr>";
      });
      h += "</table>";
      document.getElementById('cap_results_area').innerHTML = h;
    }).getCaptureData(date);
  }

  // Common Functions
  function callGas(payload, finalType) {
    document.getElementById('loader').style.display = 'flex';
    google.script.run.withSuccessHandler(res => {
      document.getElementById('loader').style.display = 'none';
      if(res.success) navTo('final-' + finalType);
      else alert("Error: " + res.error);
    }).withFailureHandler(err => {
      document.getElementById('loader').style.display = 'none';
      alert("System Error: " + err);
    }).processForm(payload);
  }

  function toggleDiv(id, show) { document.getElementById(id).style.display = show ? 'block' : 'none'; }
  function formatDate(val) { if(!val) return ""; const p = val.split('-'); return `${p[2]}/${p[1]}/${p[0]}`; }
  function goHome() { location.reload(); }
</script>
</body>
</html>
