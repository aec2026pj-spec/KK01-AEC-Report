<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #1a237e; --secondary: #303f9f; --accent: #ffd600; --success: #2e7d32; --danger: #c62828; --bg: #f5f7fa; }
    body { font-family: 'Kanit', sans-serif; background: var(--bg); margin: 0; padding: 0; color: #333; }
    .container { max-width: 600px; margin: 0 auto; padding: 15px; box-sizing: border-box; }
    .card { background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 20px; margin-bottom: 20px; border: 1px solid #e0e6ed; }
    h1 { color: var(--primary); text-align: center; font-size: 24px; margin: 10px 0; font-weight: 600; text-transform: uppercase; }
    h2 { font-size: 18px; color: var(--secondary); margin-bottom: 15px; border-left: 5px solid var(--accent); padding-left: 10px; }
    
    .input-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px; color: #555; }
    input, select, textarea { width: 100%; padding: 12px; border: 2px solid #eef0f2; border-radius: 12px; font-size: 15px; font-family: 'Kanit'; box-sizing: border-box; }
    
    .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
    .btn-menu { border: none; border-radius: 18px; padding: 25px 10px; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 12px; font-weight: 600; transition: 0.3s; font-size: 14px; }
    .btn-site { background: linear-gradient(135deg, #0288d1, #01579b); }
    .btn-in { background: linear-gradient(135deg, #43a047, #1b5e20); }
    .btn-out { background: linear-gradient(135deg, #f57c00, #e65100); }
    .btn-rep { background: linear-gradient(135deg, #7b1fa2, #4a148c); }
    .btn-exp { background: linear-gradient(135deg, #d81b60, #880e4f); }
    .btn-cap { background: linear-gradient(135deg, #455a64, #263238); }
    
    .main-btn { background: var(--primary); color: white; width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 18px; font-weight: 600; cursor: pointer; margin-top: 10px; }
    .back-btn { background: #f1f3f5; color: #495057; }
    .preview-img { max-width: 100%; border-radius: 12px; margin-top: 10px; border: 2px solid #ddd; }
    .page { display: none; } .page.active { display: block; }
    
    #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
    .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: var(--primary); color: white; }
  </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p></div>

<div class="container">
  <div id="page-home" class="page active">
    <h1>2026 AEC Report</h1>
    <div class="card">
      <div class="input-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô (Name)</label>
        <input type="text" id="main_name" placeholder="‡∏à‡∏≥‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥">
      </div>
      <div class="input-group">
        <label>‡∏†‡∏≤‡∏Ñ‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î (Region)</label>
        <select id="main_region">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ --</option>
          <option>BKK</option><option>CR</option><option>ER</option><option>NER</option><option>NR</option><option>SR</option><option>TE</option><option>DR</option><option>OFFICE</option>
        </select>
      </div>
    </div>
    <div class="menu-grid">
      <button class="btn-menu btn-site" onclick="navTo('check', 'Site Check In')"><i class="fas fa-map-pin fa-2x"></i>Site Check In</button>
      <button class="btn-menu btn-in" onclick="navTo('check', 'Check In')"><i class="fas fa-sign-in-alt fa-2x"></i>Check In</button>
      <button class="btn-menu btn-out" onclick="navTo('check', 'Check Out')"><i class="fas fa-sign-out-alt fa-2x"></i>Check Out</button>
      <button class="btn-menu btn-rep" onclick="navTo('report')"><i class="fas fa-file-contract fa-2x"></i>Report</button>
      <button class="btn-menu btn-exp" onclick="navTo('expenses')"><i class="fas fa-wallet fa-2x"></i>Expenses</button>
      <button class="btn-menu btn-cap" onclick="navTo('capture')"><i class="fas fa-camera fa-2x"></i>Capture</button>
    </div>
  </div>

  <div id="page-check" class="page">
    <h2 id="check-title">Check In</h2>
    <div id="check-fields"></div>
    <div class="card">
      <label>üì∏ ‡∏†‡∏≤‡∏û‡∏ñ‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏Å‡∏±‡∏î</label>
      <input type="file" id="check_file" accept="image/*" capture="camera" onchange="handleImg(this, 'check_preview')">
      <div id="check_preview_div" style="display:none; text-align:center;">
        <img id="check_preview" class="preview-img">
        <p id="gps_info" style="font-size:12px; color:blue;"></p>
      </div>
    </div>
    <button class="main-btn" onclick="submitCheck()">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <button class="main-btn back-btn" onclick="goHome()">‡∏Å‡∏•‡∏±‡∏ö</button>
  </div>

  <div id="page-report" class="page">
    <h2>üìù ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏• (Report)</h2>
    <div class="card">
      <label>Buddy (‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô)</label><input type="text" id="rep_buddy">
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label><input type="date" id="rep_date">
      <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</label>
      <select id="rep_jobtype" onchange="toggleDiv('rep_etc_div', this.value==='‡∏á‡∏≤‡∏ô ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ')">
        <option>‡∏á‡∏≤‡∏ô CR</option><option>‡∏á‡∏≤‡∏ô OFFICE</option><option>‡∏á‡∏≤‡∏ô TE</option><option>‡∏á‡∏≤‡∏ô DRONE</option><option>‡∏á‡∏≤‡∏ô ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
      </select>
      <div id="rep_etc_div" style="display:none; margin-top:10px;"><label>‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô</label><input type="text" id="rep_etc"></div>
      <label style="margin-top:10px;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</label><textarea id="rep_detail" rows="3"></textarea>
    </div>
    <button class="main-btn" onclick="handleReportStep()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ûî</button>
    <button class="main-btn back-btn" onclick="goHome()">‡∏Å‡∏•‡∏±‡∏ö</button>
  </div>

  <div id="page-report-cr" class="page">
    <h2 id="cr-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô CR</h2>
    <div id="cr-container"></div>
  </div>

  <div id="page-expenses" class="page">
    <h2>üí∞ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (Expenses)</h2>
    <div id="exp-f1">
      <div class="card">
        <label>Buddy (‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô)</label><input type="text" id="exp_buddy">
        <label>‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="exp_date">
        <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</label>
        <select id="exp_jobtype" onchange="toggleDiv('exp_etc_div', this.value==='‡∏á‡∏≤‡∏ô ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ')">
          <option>‡∏á‡∏≤‡∏ô CR</option><option>‡∏á‡∏≤‡∏ô OFFICE</option><option>‡∏á‡∏≤‡∏ô TE</option><option>‡∏á‡∏≤‡∏ô DRONE</option><option>‡∏á‡∏≤‡∏ô ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
        </select>
        <div id="exp_etc_div" style="display:none;"><label>‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô</label><input type="text" id="exp_etc"></div>
        <label style="margin-top:10px;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</label><textarea id="exp_detail" rows="2"></textarea>
      </div>
      <div class="card">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ã‡∏ï‡πå</label><input type="text" id="exp_epsite">
        <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label><input type="text" id="exp_eppv">
        <label>‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô (No.1)</label><input type="number" id="exp_oil" value="0">
        <label>‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å (No.2)</label><input type="number" id="exp_hotel" value="0">
        <label>‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏° (No.3)</label><input type="number" id="exp_ccr" value="0">
        <label>‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á (No.4)</label><input type="number" id="exp_trav" value="0">
      </div>
      <button class="main-btn" onclick="toggleExpStep(2)">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ûî</button>
    </div>

    <div id="exp-f2" style="display:none;">
      <div class="card">
        <label>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©</label>
        <select id="exp_spc_type" onchange="toggleDiv('exp_spc_div', this.value!=='‡πÑ‡∏°‡πà‡∏°‡∏µ')">
          <option>‡πÑ‡∏°‡πà‡∏°‡∏µ</option><option>‡πÄ‡∏ö‡∏¥‡∏Å‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô/‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡∏°/‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ</option><option>‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option><option>‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤</option><option>‡∏ó‡∏≥‡∏ü‡∏±‡∏ô (‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£)</option><option>‡∏Ñ‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•/‡∏Ñ‡πà‡∏≤‡∏¢‡∏≤</option><option>‡∏Ñ‡πà‡∏≤‡∏™‡∏±‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡∏≤‡∏£</option><option>‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</option><option>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏µ/‡∏õ‡∏Å‡∏™.</option>
        </select>
        <div id="exp_spc_div" style="display:none; margin-top:10px;"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label><input type="number" id="exp_spc_cost" value="0"></div>
      </div>
      <div class="card">
        <label>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏¥‡∏• ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</label>
        <select id="exp_nb_type" onchange="toggleDiv('exp_nb_div', this.value!=='‡πÑ‡∏°‡πà‡∏°‡∏µ')"><option>‡πÑ‡∏°‡πà‡∏°‡∏µ</option><option>‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏¥‡∏•</option></select>
        <div id="exp_nb_div" style="display:none; margin-top:10px;">
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</label><input type="text" id="exp_nb_name">
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label><input type="number" id="exp_nb_cost" value="0">
        </div>
      </div>
      <div class="card">
        <label>‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏° (SCR)</label>
        <select id="exp_scr_type" onchange="toggleDiv('exp_scr_div', this.value!=='‡πÑ‡∏°‡πà‡∏°‡∏µ')"><option>‡πÑ‡∏°‡πà‡∏°‡∏µ</option><option>‡∏°‡∏µ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°</option></select>
        <div id="exp_scr_div" style="display:none; margin-top:10px;">
          <label>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ã‡∏ï‡πå</label><input type="text" id="exp_scr_name">
          <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢</label><input type="date" id="exp_scr_date">
          <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label><input type="text" id="exp_scr_pro">
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label><input type="number" id="exp_scr_cost" value="0">
        </div>
      </div>
      <button class="main-btn" onclick="toggleExpStep(3)">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‚ûî</button>
    </div>

    <div id="exp-f3" style="display:none;">
      <div class="card">
        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ö‡∏¥‡∏• (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡∏£‡∏π‡∏õ / ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3MB)</label>
        <input type="file" id="exp_files" multiple accept="image/*" onchange="handleImg(this, 'exp_preview')">
        <div id="exp_preview_div" style="display:none; text-align:center;">
          <img id="exp_preview" class="preview-img">
          <p id="exp_img_count"></p>
        </div>
      </div>
      <button class="main-btn" onclick="summarizeExp()">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚ûî</button>
    </div>

    <div id="exp-summary" style="display:none;">
      <div class="card" id="exp_sum_content"></div>
      <button class="main-btn" onclick="submitExp()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <button class="main-btn back-btn" onclick="toggleExpStep(1)">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
    </div>
  </div>

  <div id="page-capture" class="page">
    <h2>üì∏ Capture Report</h2>
    <div class="card">
      <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</label>
      <select id="cap_date_sel"></select>
      <button class="main-btn" style="background:#0097A7" onclick="fetchCapture()">‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
    <div id="cap_result"></div>
    <button class="main-btn back-btn" onclick="goHome()">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
  </div>

  <div id="page-final-1" class="page">
    <div class="card" style="text-align:center;">
      <i class="fas fa-check-circle fa-4x" style="color:var(--success)"></i>
      <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2>
      <p>‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏°</p>
      <div style="background:#FFF3E0; padding:15px; border-radius:15px; color:#E65100; font-weight:600; margin:15px 0;">
        <i class="fas fa-hard-hat"></i> Safety First! ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö
      </div>
      <button class="main-btn" onclick="goHome()">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
    </div>
  </div>

  <div id="page-final-2" class="page">
    <div class="card" style="text-align:center;">
      <i class="fas fa-paper-plane fa-4x" style="color:var(--secondary)"></i>
      <h2>‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!</h2>
      <p>‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö</p>
      <button class="main-btn" onclick="goHome()">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
    </div>
  </div>
</div>

<script>
  let currentStatus = "";
  let currentImgs = [];
  let currentGPS = { stamp: "", code: "", addr: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." };
  let crSiteCount = 1;

  // Initializing LocalStorage and Dates
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('main_name').value = localStorage.getItem('aec_name') || "";
    document.getElementById('main_region').value = localStorage.getItem('aec_region') || "";
    
    const sel = document.getElementById('cap_date_sel');
    for(let i=0; i<8; i++){
      let d = new Date(); d.setDate(d.getDate() - i);
      let ds = d.toLocaleDateString('th-TH');
      sel.innerHTML += `<option value="${ds}">${ds}</option>`;
    }
  });

  function saveProfile() {
    const name = document.getElementById('main_name').value;
    const region = document.getElementById('main_region').value;
    if(!name || !region) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏Ñ‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î"); return null; }
    localStorage.setItem('aec_name', name);
    localStorage.setItem('aec_region', region);
    return { name, region };
  }

  function navTo(pageId, status = "") {
    const profile = saveProfile(); if(!profile) return;
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-' + pageId).classList.add('active');
    if(status) {
      currentStatus = status;
      document.getElementById('check-title').innerText = status;
      renderCheckFields(status);
    }
  }

  function renderCheckFields(status) {
    const box = document.getElementById('check-fields');
    if(status === 'Site Check In') { box.innerHTML = ""; return; }
    const isOut = status.includes('Out');
    box.innerHTML = `
      <div class="card">
        <label>‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£</label><input type="text" id="c_buddy">
        <label>‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÉ‡∏Ñ‡∏£</label><input type="text" id="c_car">
        <label>‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå</label><input type="number" id="c_mile">
        <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà ${isOut ? 'Out' : 'In'}</label><input type="text" id="c_place">
        <label>${isOut ? 'BRIEF' : 'PLAN'}</label><textarea id="c_plan"></textarea>
      </div>
    `;
  }

  async function handleImg(input, previewId) {
    currentImgs = [];
    if(input.files.length > 0) {
      for(let f of input.files) {
        if(f.size > 3*1024*1024) continue;
        const b64 = await new Promise(r => {
          const rd = new FileReader(); rd.onload = () => r(rd.result); rd.readAsDataURL(f);
        });
        currentImgs.push(b64);
      }
      document.getElementById(previewId).src = currentImgs[0];
      document.getElementById(previewId + '_div').style.display = 'block';
      if(previewId === 'exp_preview') document.getElementById('exp_img_count').innerText = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ${currentImgs.length} ‡∏£‡∏π‡∏õ`;
      getGPS();
    }
  }

  function getGPS() {
    navigator.geolocation.getCurrentPosition(pos => {
      currentGPS.code = pos.coords.latitude + "," + pos.coords.longitude;
      currentGPS.stamp = new Date().toLocaleString('th-TH');
      document.getElementById('gps_info').innerText = "üìç ‡∏û‡∏¥‡∏Å‡∏±‡∏î: " + currentGPS.code;
    });
  }

  function submitCheck() {
    const prof = saveProfile();
    const data = {
      date: new Date().toLocaleDateString('th-TH'),
      time: new Date().toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'}),
      name: prof.name, region: prof.region, status: currentStatus,
      geoStamp: currentGPS.stamp, geoCode: currentGPS.code, geoAddress: currentGPS.addr,
      device: /Mobi|Android/i.test(navigator.userAgent) ? "Mobile" : "PC",
      images: currentImgs,
      buddy: document.getElementById('c_buddy')?.value || "",
      car: document.getElementById('c_car')?.value || "",
      mileage: document.getElementById('c_mile')?.value || "",
      place: document.getElementById('c_place')?.value || "",
      plan: document.getElementById('c_plan')?.value || ""
    };
    sendToGas(data, currentStatus.includes('Out') ? '2' : '1');
  }

  function handleReportStep() {
    if(document.getElementById('rep_jobtype').value === '‡∏á‡∏≤‡∏ô CR') {
      navTo('report-cr');
      renderCRForm(1);
    } else {
      submitReport();
    }
  }

  function renderCRForm(n) {
    crSiteCount = n;
    const cont = document.getElementById('cr-container');
    cont.innerHTML = `
      <div class="card">
        <h3>‡πÑ‡∏ã‡∏ï‡πå‡∏ó‡∏µ‡πà ${n}</h3>
        <label>‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏Ñ</label><select id="s_reg"><option>BKK</option><option>CR</option><option>ER</option><option>NER</option><option>NR</option><option>SR</option></select>
        <label>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ã‡∏ï‡πå</label><input type="text" id="s_name">
        <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label><input type="text" id="s_pro">
        <label>‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏á‡∏≤‡∏ô</label>
        <select id="s_job" onchange="toggleDiv('s_etc_div', this.value==='‡∏≠‡∏∑‡πà‡∏ô ‡πÜ')">
          <option>‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ô‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥ CR - CRL</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥ CR + ‡∏ô‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡∏ó‡∏≥‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥ CR + ‡∏ó‡∏≥‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Ñ‡∏°</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà SA</option><option>‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô (‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß)</option><option>‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
        </select>
        <div id="s_etc_div" style="display:none; margin-top:10px;"><label>‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡∏á‡∏≤‡∏ô</label><input type="text" id="s_etc"></div>
        <label style="margin-top:10px;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</label><input type="text" id="s_det">
        <label>‡∏ú‡∏π‡πâ‡∏ô‡∏≥-‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input type="text" id="s_ld">
        <label>‡∏°‡∏µ‡πÑ‡∏ã‡∏ï‡πå‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</label>
        <select id="s_next"><option value="no">‡πÑ‡∏°‡πà‡∏°‡∏µ/‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</option><option value="yes">‡∏°‡∏µ‡πÑ‡∏ã‡∏ï‡πå‡∏ó‡∏µ‡πà ${n+1}</option></select>
      </div>
      <button class="main-btn" onclick="processCRNext()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ/‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
    `;
  }

  let crSummaryData = {};
  function processCRNext() {
    const n = crSiteCount;
    const start = 19 + (n-1)*6;
    crSummaryData[18] = document.getElementById('s_reg').value;
    crSummaryData[start] = document.getElementById('s_name').value;
    crSummaryData[start+1] = document.getElementById('s_pro').value;
    crSummaryData[start+2] = document.getElementById('s_job').value;
    crSummaryData[start+3] = document.getElementById('s_etc')?.value || "";
    crSummaryData[start+4] = document.getElementById('s_det').value;
    crSummaryData[start+5] = document.getElementById('s_ld').value;

    if(document.getElementById('s_next').value === 'yes' && n < 4) {
      renderCRForm(n+1);
    } else {
      submitReport(crSummaryData);
    }
  }

  function submitReport(crData = null) {
    const prof = saveProfile();
    const data = {
      date: formatDate(document.getElementById('rep_date').value),
      time: "", name: prof.name, region: prof.region, status: "Report",
      device: /Mobi|Android/i.test(navigator.userAgent) ? "Mobile" : "PC",
      buddy: document.getElementById('rep_buddy').value,
      extra: {
        15: document.getElementById('rep_jobtype').value,
        16: document.getElementById('rep_etc')?.value || "",
        17: document.getElementById('rep_detail').value,
        ...crData
      }
    };
    sendToGas(data, '2');
  }

  function toggleExpStep(s) {
    document.getElementById('exp-f1').style.display = s === 1 ? 'block' : 'none';
    document.getElementById('exp-f2').style.display = s === 2 ? 'block' : 'none';
    document.getElementById('exp-f3').style.display = s === 3 ? 'block' : 'none';
    document.getElementById('exp-summary').style.display = 'none';
  }

  function summarizeExp() {
    const oil = Number(document.getElementById('exp_oil').value) || 0;
    const hotel = Number(document.getElementById('exp_hotel').value) || 0;
    const ccr = Number(document.getElementById('exp_ccr').value) || 0;
    const trav = Number(document.getElementById('exp_trav').value) || 0;
    const spc = Number(document.getElementById('exp_spc_cost').value) || 0;
    const nb = Number(document.getElementById('exp_nb_cost').value) || 0;
    const scr = Number(document.getElementById('exp_scr_cost').value) || 0;
    const total = oil+hotel+ccr+trav+spc+nb+scr;

    let html = `<h3>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h3><p>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <b>${total}</b> ‡∏ö‡∏≤‡∏ó</p><p>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏π‡∏õ: ${currentImgs.length}</p><hr>`;
    if(oil>0) html += `‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô: ${oil}<br>`;
    if(hotel>0) html += `‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å: ${hotel}<br>`;
    if(total === 0) html += `‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢`;
    
    document.getElementById('exp_sum_content').innerHTML = html;
    document.getElementById('exp-f3').style.display = 'none';
    document.getElementById('exp-summary').style.display = 'block';
  }

  function submitExp() {
    const prof = saveProfile();
    const data = {
      date: formatDate(document.getElementById('exp_date').value),
      time: "", name: prof.name, region: prof.region, status: "Expenses",
      device: /Mobi|Android/i.test(navigator.userAgent) ? "Mobile" : "PC",
      buddy: document.getElementById('exp_buddy').value,
      images: currentImgs,
      extra: {
        15: document.getElementById('exp_jobtype').value,
        16: document.getElementById('exp_etc')?.value || "",
        17: document.getElementById('exp_detail').value,
        43: document.getElementById('exp_epsite').value,
        44: document.getElementById('exp_eppv').value,
        45: document.getElementById('exp_oil').value,
        46: document.getElementById('exp_hotel').value,
        47: document.getElementById('exp_ccr').value,
        48: document.getElementById('exp_trav').value,
        49: document.getElementById('exp_spc_type').value,
        50: document.getElementById('exp_spc_cost').value,
        51: document.getElementById('exp_nb_name')?.value || "",
        52: document.getElementById('exp_nb_cost')?.value || 0,
        53: document.getElementById('exp_scr_type').value,
        54: document.getElementById('exp_scr_name')?.value || "",
        55: formatDate(document.getElementById('exp_scr_date')?.value || ""),
        56: document.getElementById('exp_scr_pro')?.value || "",
        57: document.getElementById('exp_scr_cost')?.value || 0
      }
    };
    sendToGas(data, '2');
  }

  function fetchCapture() {
    const date = document.getElementById('cap_date_sel').value;
    document.getElementById('loader').style.display = 'flex';
    google.script.run.withSuccessHandler(res => {
      document.getElementById('loader').style.display = 'none';
      let html = "<table><tr>" + res.headers.slice(0,10).map(h => `<th>${h}</th>`).join('') + "</tr>";
      res.rows.forEach(r => {
        html += "<tr>" + r.slice(0,10).map(c => `<td>${c}</td>`).join('') + "</tr>";
      });
      html += "</table>";
      document.getElementById('cap_result').innerHTML = html;
    }).getCaptureData(date);
  }

  function sendToGas(payload, finalType) {
    document.getElementById('loader').style.display = 'flex';
    google.script.run.withSuccessHandler(res => {
      document.getElementById('loader').style.display = 'none';
      if(res.success) navTo('final-' + finalType);
      else alert("Error: " + res.error);
    }).processForm(payload);
  }

  function toggleDiv(id, show) { document.getElementById(id).style.display = show ? 'block' : 'none'; }
  function formatDate(d) { if(!d) return ""; const a = d.split('-'); return `${a[2]}/${a[1]}/${a[0]}`; }
  function goHome() { location.reload(); }
</script>

</body>
</html>
